<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HTML5 Banner Generator</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <style>
    :root{
      --primary:#667eea;
      --success:#4facfe;
      --danger:#ff6b6b;
      --dark:#2c3e50;
      --white:#ffffff;
      --shadow:0 10px 30px rgba(0,0,0,0.10);
      --border-radius:12px;

      --bg1:#667eea;
      --bg2:#764ba2;
    }

    *{margin:0;padding:0;box-sizing:border-box;}

    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      min-height:100vh;
      color:var(--dark);
      line-height:1.6;
    }

    .container{
      max-width:1500px;
      margin:0 auto;
      padding:20px;
    }

    .header{
      text-align:center;
      margin-bottom:30px;
      color:var(--white);
    }

    .header h1{
      font-size:2.5rem;
      font-weight:700;
      margin-bottom:10px;
      text-shadow:0 2px 10px rgba(0,0,0,0.2);
    }

    .card{
      background:var(--white);
      border-radius:var(--border-radius);
      padding:26px;
      box-shadow:var(--shadow);
      transition:transform .25s ease, box-shadow .25s ease;
    }
    .card:hover{ transform:translateY(-2px); }

    .step-content{ display:none; }
    .step-content.active{ display:block; animation:fadeIn .35s ease; }
    @keyframes fadeIn{ from{opacity:0;} to{opacity:1;} }

    /* ---------- Buttons ---------- */
    .button-group{
      display:flex;
      gap:15px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:18px;
    }

    .btn{
      padding:12px 30px;
      border:none;
      border-radius:25px;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      transition:all .25s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .btn-primary{
      background: linear-gradient(135deg, var(--primary), #5a6fd8);
      color:var(--white);
    }
    .btn-primary:hover:not(:disabled){
      transform:translateY(-2px);
      box-shadow:0 10px 25px rgba(102,126,234,.30);
    }

    .btn-secondary{ background:#6c757d; color:var(--white); }
    .btn-secondary:hover{ background:#545b62; transform:translateY(-2px); }

    .btn-success{
      background: linear-gradient(135deg, var(--success), #00b4db);
      color:var(--white);
    }
    .btn-success:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 25px rgba(79,172,254,.30);
    }

    /* ---------- Step 1: Formats ---------- */
    .format-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
      gap:20px;
      margin-top:18px;
      margin-bottom:22px;
    }

    .format-card{
      position:relative;
      cursor:pointer;
      border-radius:var(--border-radius);
      border:3px solid #e0e0e0;
      background:#f8f9fa;
      overflow:hidden;
      transition:all .25s ease;
    }
    .format-card:hover{ transform:translateY(-3px); box-shadow:var(--shadow); }
    .format-card input[type="checkbox"]{ display:none; }

    .format-preview{ padding:20px; text-align:center; transition:all .25s ease; }

    .preview-box{
      background:var(--white);
      border-radius:10px;
      padding:20px;
      margin-bottom:15px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      border:2px dashed #ddd;
      min-height:90px;
      color:#1f2430;
    }

    .checkmark{
      position:absolute;
      top:10px;
      right:10px;
      background: var(--success);
      color:var(--white);
      width:32px;
      height:32px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      transform:scale(.6);
      transition:all .25s ease;
      box-shadow:0 10px 25px rgba(0,0,0,.15);
    }

    /* Checked State */
    .format-card input[type="checkbox"]:checked + .format-preview{
      background: linear-gradient(135deg, #5B6CFF, #35C6FF);
      color:#fff;
    }
    .format-card input[type="checkbox"]:checked + .format-preview .preview-box{
      background: rgba(10, 15, 30, 0.42);
      border:1px solid rgba(255,255,255,0.40);
      box-shadow: 0 10px 25px rgba(0,0,0,0.18), inset 0 1px 0 rgba(255,255,255,0.18);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color:#fff;
    }
    .format-card input[type="checkbox"]:checked + .format-preview .preview-box span{
      color:#fff;
      font-weight:900;
      letter-spacing:.2px;
      text-shadow:0 2px 10px rgba(0,0,0,.25);
    }
    .format-card input[type="checkbox"]:checked + .format-preview .preview-box small{
      color: rgba(255,255,255,0.92);
      text-shadow:0 2px 10px rgba(0,0,0,.20);
    }
    .format-card:has(input[type="checkbox"]:checked){
      border-color: rgba(53,198,255,0.95);
      box-shadow: 0 14px 35px rgba(0,0,0,0.18);
    }
    .format-card input[type="checkbox"]:checked ~ .checkmark{
      opacity:1;
      transform:scale(1);
    }

    /* ---------- Step 2: Stage ---------- */
    .stage{
      width:100%;
      display:flex;
      justify-content:center;
    }

    .stage-inner{
      width:100%;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      gap:22px;
    }

    .left-panels{
      display:grid;
      grid-template-columns: repeat(3, minmax(280px, 340px));
      gap:22px;
      justify-content:center;
      align-items:stretch;
      transition:transform .35s ease;
    }

    .left-panels .card{
      height: 100%;
      min-height: 520px;
      display:flex;
      flex-direction:column;
    }

    /* Upload */
    .upload-area{
      border:3px dashed #ddd;
      border-radius:var(--border-radius);
      padding:32px;
      text-align:center;
      cursor:pointer;
      transition:all .25s ease;
      position:relative;
      background:#f8f9fa;
    }
    .upload-area:hover, .upload-area.dragover{
      border-color:var(--primary);
      background: rgba(102,126,234,0.06);
    }
    .upload-area input[type="file"]{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
    }
    .upload-area i{
      font-size:3rem;
      color:var(--primary);
      margin-bottom:12px;
    }

    .uploaded-images{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(92px, 1fr));
      gap:10px;
      margin-top:16px;
    }
    .uploaded-image{
      position:relative;
      aspect-ratio:1;
      border-radius:10px;
      overflow:hidden;
      background:#f0f0f0;
      cursor:grab;
      outline:2px solid transparent;
      transition: outline .15s ease, transform .15s ease, opacity .15s ease;
    }
    .uploaded-image:active{ cursor:grabbing; }
    .uploaded-image.dragging{
      opacity:.55;
      transform: scale(.98);
    }
    .uploaded-image.dragover{
      outline:2px dashed rgba(102,126,234,0.9);
      outline-offset:-2px;
    }
    .uploaded-image img{
      width:100%;
      height:100%;
      object-fit:cover;
      pointer-events:none;
      user-select:none;
    }
    .uploaded-image .remove{
      position:absolute;
      top:6px;
      right:6px;
      background:var(--danger);
      color:var(--white);
      border:none;
      border-radius:50%;
      width:26px;
      height:26px;
      cursor:pointer;
      font-size:.85rem;
      z-index:2;
    }
    .uploaded-image .number{
      position:absolute;
      bottom:6px;
      left:6px;
      background:var(--primary);
      color:var(--white);
      padding:2px 6px;
      border-radius:6px;
      font-size:.80rem;
      font-weight:800;
      z-index:2;
    }

    /* Inputs */
    .input-group{ margin-top:14px; }
    .input-group label{
      display:block;
      margin-bottom:8px;
      font-weight:700;
      color:var(--dark);
    }
    .input-group input,
    .input-group select{
      width:100%;
      padding:12px 14px;
      border:2px solid #e0e0e0;
      border-radius:10px;
      font-size:1rem;
      transition:all .25s ease;
      background:#fff;
    }
    .input-group input:focus,
    .input-group select:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(102,126,234,0.12);
    }

    /* Small helper row for template */
    .template-row{
      margin-top:10px;
      padding:12px 12px;
      border:1px solid rgba(0,0,0,0.08);
      border-radius:12px;
      background:#fbfcff;
    }
    .template-meta{
      margin-top:8px;
      font-size:.85rem;
      color:#6b7280;
      line-height:1.35;
    }
    .template-swatch{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-top:8px;
      flex-wrap:wrap;
    }
    .swatch{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid rgba(0,0,0,0.10);
      border-radius:999px;
      background:#fff;
      font-size:.82rem;
      color:#374151;
      user-select:none;
    }
    .dot{
      width:10px;
      height:10px;
      border-radius:50%;
      background:#999;
      display:inline-block;
    }

    /* Character hint / warning */
    .char-hint{
      margin-top:6px;
      font-size:.72rem;
      color:#6b7280;
      display:flex;
      justify-content:flex-end;
      gap:10px;
      user-select:none;
    }
    .char-hint.over{
      color: var(--danger);
      font-weight:800;
    }
    .input-over{
      border-color: var(--danger) !important;
      box-shadow:0 0 0 3px rgba(255,107,107,0.18) !important;
    }

    /* Preview Panel */
    .preview-panel{
      width:0;
      max-width:0;
      opacity:0;
      pointer-events:none;
      transition: width .35s ease, max-width .35s ease, opacity .25s ease;
    }

    .stage.has-preview .left-panels{
      transform: translateX(-12px);
    }

    .stage.has-preview .preview-panel{
      width: 100%;
      max-width: clamp(520px, 52vw, 980px);
      opacity:1;
      pointer-events:auto;
    }

    .preview-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .preview-head .title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      font-size:1.15rem;
    }

    .toggle-preview{
      border:1px solid rgba(102,126,234,.25);
      background:#f3f6ff;
      color:#3c4cb4;
      padding:8px 14px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
    }

    .preview-grid{
      display:grid;
      gap:16px;
      align-items:start;
      justify-items:stretch;
    }

    .preview-grid.layout-1{
      grid-template-columns: 1fr;
      justify-items:center;
    }

    .preview-grid.layout-2{
      grid-template-columns: 1fr 1fr;
    }

    .preview-grid.layout-3{
      grid-template-columns: 1fr 1.35fr;
      grid-template-areas:
        "a b"
        "a c";
    }
    .preview-grid.layout-3 .preview-item[data-format="300x600"]{ grid-area:a; }
    .preview-grid.layout-3 .preview-item[data-format="300x250"]{ grid-area:b; }
    .preview-grid.layout-3 .preview-item[data-format="970x250"]{ grid-area:c; }

    .preview-item{
      background:#f7f9ff;
      border:1px solid rgba(0,0,0,0.06);
      border-radius:14px;
      padding:12px;
      overflow:hidden;
      box-shadow: 0 10px 24px rgba(0,0,0,0.06);
    }

    .preview-item h4{
      margin:4px 0 10px 0;
      text-align:center;
      font-weight:900;
      color:#1f2430;
    }

    .iframe-viewport{
      width:100%;
      border-radius:12px;
      overflow:hidden;
      background:#fff;
      border:1px solid rgba(0,0,0,0.08);
    }
    .iframe-viewport iframe{
      border:0;
      display:block;
      background:transparent;
      transform-origin:0 0;
    }

    /* Details accordion */
    details.preview-details{
      margin-top:14px;
      background:#fff;
      border:1px solid rgba(0,0,0,0.08);
      border-radius:14px;
      overflow:hidden;
    }
    details.preview-details > summary{
      cursor:pointer;
      list-style:none;
      padding:14px 16px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:#fbfcff;
    }
    details.preview-details > summary::-webkit-details-marker{ display:none; }
    .details-body{
      padding:14px 16px;
      font-size:.95rem;
      color:#334155;
      border-top:1px solid rgba(0,0,0,0.06);
      word-break:break-word;
    }
    .details-label{ font-weight:900; color:#111827; }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:.88rem;
      background:#f3f4f6;
      padding:10px 12px;
      border-radius:10px;
      margin-top:8px;
      overflow:auto;
      white-space:pre-wrap;
    }

    /* ---------- Export Modal ---------- */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:18px;
    }
    .modal.open{ display:flex; }
    .modal-backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(2px);
    }
    .modal-card{
      position:relative;
      width: min(520px, 100%);
      background:#fff;
      border-radius:16px;
      box-shadow: 0 18px 55px rgba(0,0,0,0.25);
      padding:22px;
      z-index:1;
    }
    .modal-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      font-size:1.1rem;
      margin-bottom:10px;
      color:#111827;
    }
    .modal-body{
      color:#374151;
      font-size:0.98rem;
      line-height:1.55;
    }
    .modal-actions{
      display:flex;
      gap:12px;
      justify-content:flex-end;
      margin-top:16px;
      flex-wrap:wrap;
    }

    /* ---------- Password Gate ---------- */
    .pw-gate{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10000;
      padding:18px;
    }
    .pw-backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(2px);
    }
    .pw-card{
      position:relative;
      width: min(520px, 100%);
      background:#fff;
      border-radius:16px;
      box-shadow: 0 18px 55px rgba(0,0,0,0.25);
      padding:22px;
      z-index:1;
    }
    .pw-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      font-size:1.1rem;
      margin-bottom:10px;
      color:#111827;
    }
    .pw-body{
      color:#374151;
      font-size:0.98rem;
      line-height:1.55;
    }
    .pw-actions{
      display:flex;
      gap:12px;
      justify-content:flex-end;
      margin-top:16px;
      flex-wrap:wrap;
    }
    .pw-error{
      margin-top:10px;
      font-size:.9rem;
      color: var(--danger);
      font-weight:800;
      display:none;
    }

    /* ---------- Responsive ---------- */
    @media (max-width: 1260px){
      .left-panels{
        grid-template-columns: repeat(2, minmax(280px, 360px));
      }
      .left-panels .card{ min-height: 480px; }
      .stage.has-preview .preview-panel{
        max-width: clamp(480px, 54vw, 900px);
      }
      .left-panels .card:nth-child(3){
        grid-column: 1 / -1;
        min-height: 340px;
      }
    }

    @media (max-width: 980px){
      .stage-inner{
        flex-direction:column;
        align-items:center;
      }
      .left-panels{
        grid-template-columns: 1fr;
        width:min(520px, 100%);
      }
      .left-panels .card{
        min-height: unset;
      }
      .preview-panel{
        width:100% !important;
        max-width: min(920px, 100%) !important;
        opacity:1 !important;
        pointer-events:auto !important;
      }
      .stage.has-preview .left-panels{ transform:none; }

      .preview-grid.layout-2,
      .preview-grid.layout-3{
        grid-template-columns: 1fr;
        grid-template-areas: none;
      }
      .preview-grid.layout-3 .preview-item{ grid-area:auto; }
    }

    @media (max-width: 600px){
      .header h1{ font-size:2rem; }
      .btn{ width:100%; justify-content:center; }
      .modal-actions{ justify-content:stretch; }
      .modal-actions .btn{ width:100%; justify-content:center; }
      .pw-actions{ justify-content:stretch; }
      .pw-actions .btn{ width:100%; justify-content:center; }
    }
  </style>
</head>

<body>
  <!-- Password Gate -->
  <div class="pw-gate" id="pwGate" aria-hidden="false" role="dialog" aria-modal="true">
    <div class="pw-backdrop"></div>
    <div class="pw-card">
      <div class="pw-title">
        <i class="fas fa-lock" style="color:var(--primary);"></i>
        Zugang
      </div>
      <div class="pw-body">
        <div class="input-group" style="margin-top:12px;">
          <label for="pwInput">Passwort</label>
          <input type="password" id="pwInput" placeholder="Passwort eingeben" autocomplete="current-password">
        </div>
        <div class="pw-error" id="pwError">Falsches Passwort.</div>
      </div>
      <div class="pw-actions">
        <button class="btn btn-primary" id="pwSubmit" type="button">
          Weiter <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <header class="header">
      <h1><i class="fas fa-magic"></i> HTML5 Banner Generator</h1>
      <p>Erstelle professionelle Display-Banner fÃ¼r Google Ads &amp; DV360</p>
    </header>

    <!-- Step 1 -->
    <div class="step-content active" id="step1">
      <div class="card">
        <h2><i class="fas fa-th-large"></i> Banner-Formate auswÃ¤hlen</h2>

        <div class="format-grid">
          <label class="format-card" for="format-300x250">
            <input type="checkbox" id="format-300x250" value="300x250">
            <div class="format-preview">
              <div class="preview-box">
                <span style="font-weight:900;font-size:1.2em;">300Ã—250</span>
                <small>Medium Rectangle</small>
              </div>
            </div>
            <span class="checkmark"><i class="fas fa-check"></i></span>
          </label>

          <label class="format-card" for="format-300x600">
            <input type="checkbox" id="format-300x600" value="300x600">
            <div class="format-preview">
              <div class="preview-box">
                <span style="font-weight:900;font-size:1.2em;">300Ã—600</span>
                <small>Half Page</small>
              </div>
            </div>
            <span class="checkmark"><i class="fas fa-check"></i></span>
          </label>

          <label class="format-card" for="format-970x250">
            <input type="checkbox" id="format-970x250" value="970x250">
            <div class="format-preview">
              <div class="preview-box">
                <span style="font-weight:900;font-size:1.2em;">970Ã—250</span>
                <small>Billboard</small>
              </div>
            </div>
            <span class="checkmark"><i class="fas fa-check"></i></span>
          </label>
        </div>

        <div class="button-group">
          <button class="btn btn-primary" id="nextStep1" disabled>
            Weiter <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="step-content" id="step2">
      <div class="stage" id="stage">
        <div class="stage-inner">

          <!-- Left 3 cards -->
          <div class="left-panels">

            <div class="card">
              <h3><i class="fas fa-images"></i> Bilder hochladen</h3>
              <div class="upload-area" id="uploadArea" style="margin-top:14px;">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Bilder hier hinziehen oder klicken</p>
                <p style="font-size:0.9em;color:#666;margin-top:10px;">
                  Reihenfolge per Drag &amp; Drop Ã¤ndern (wird neu zu 1.jpg, 2.jpg, ... durchnummeriert)
                </p>
                <input type="file" id="imageUpload" multiple accept="image/*">
              </div>
              <div class="uploaded-images" id="uploadedImages"></div>
            </div>

            <div class="card">
              <h3><i class="fas fa-font"></i> Texte anpassen</h3>

              <div class="template-row">
                <div class="input-group" style="margin-top:0;">
                  <label for="templateSelect">Template wÃ¤hlen</label>
                  <select id="templateSelect">
                    <option value="standard">Standard</option>
                    <option value="sale">Sale</option>
                    <option value="tchibocard">Tchibocard</option>
                  </select>
                </div>

                <div class="template-meta" id="templateMeta">
                  Farben: Standard (wie aktuell)
                </div>

                <div class="template-swatch" id="templateSwatches" aria-hidden="false">
                  <span class="swatch"><span class="dot" id="dotHeadline"></span>Headline</span>
                  <span class="swatch"><span class="dot" id="dotSubline"></span>Subline</span>
                  <span class="swatch"><span class="dot" id="dotCta"></span>CTA (Gold â†’ Farbe)</span>
                </div>
              </div>

              <div class="input-group">
                <label for="headline">Headline</label>
                <input type="text" id="headline" value="Bereit fÃ¼r deine Ziele?">
                <div class="char-hint" id="headlineHint"></div>
              </div>

              <div class="input-group">
                <label for="subline">Subline</label>
                <input type="text" id="subline" value="Sport Outfits entdecken!">
                <div class="char-hint" id="sublineHint"></div>
              </div>

              <div class="input-group">
                <label for="ctaText">CTA Text</label>
                <input type="text" id="ctaText" value="Jetzt shoppen">
                <div class="char-hint" id="ctaHint"></div>
              </div>
            </div>

            <div class="card">
              <h3><i class="fas fa-link"></i> Click-URL</h3>

              <div class="input-group">
                <label for="zipName">Naming (fÃ¼r ZIP-Datei)</label>
                <input type="text" id="zipName" placeholder="z.B. KW02_BackToGym" required>
              </div>

              <div class="input-group">
                <label for="clickUrl">Ziel-URL</label>
                <input type="url" id="clickUrl" placeholder="https://example.com" required>
              </div>

              <p style="margin-top:14px;font-size:0.9em;color:#6b7280;">
                Hinweis: <b>utm_source=dbm</b> &amp; <b>utm_medium=cpm</b> werden automatisch ergÃ¤nzt.
              </p>
            </div>

          </div>

          <!-- Preview panel -->
          <div class="preview-panel">
            <div class="card">
              <div class="preview-head">
                <div class="title"><i class="fas fa-eye"></i> Vorschau</div>
                <button class="toggle-preview" id="togglePreviewBtn" type="button">
                  Ausblenden
                </button>
              </div>

              <div class="preview-grid" id="previewGrid"></div>

              <details class="preview-details" id="previewDetails">
                <summary>
                  Details
                  <i class="fas fa-chevron-down" aria-hidden="true"></i>
                </summary>
                <div class="details-body">
                  <div class="details-label">Naming</div>
                  <div id="detailName">-</div>

                  <div class="details-label" style="margin-top:12px;">Template</div>
                  <div id="detailTemplate">-</div>

                  <div class="details-label" style="margin-top:12px;">Final clickTag</div>
                  <div class="mono" id="detailClickTag">-</div>

                  <div class="details-label" style="margin-top:12px;">Impr.-Tag</div>
                  <div class="mono" id="detailImprTag">-</div>
                </div>
              </details>
            </div>
          </div>

        </div>
      </div>

      <div class="button-group">
        <button class="btn btn-secondary" id="backStep1">
          <i class="fas fa-arrow-left"></i> ZurÃ¼ck
        </button>
        <button class="btn btn-primary" id="createPreview">
          Vorschau erstellen <i class="fas fa-eye"></i>
        </button>
        <button class="btn btn-success" id="exportBanners">
          Export starten <i class="fas fa-download"></i>
        </button>
      </div>
    </div>

  </div>

  <!-- Export Success Modal -->
  <div class="modal" id="exportModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-backdrop" id="exportModalBackdrop"></div>
    <div class="modal-card">
      <div class="modal-title">
        <i class="fas fa-check-circle" style="color:var(--success);"></i>
        Download erstellt
      </div>
      <div class="modal-body">
        Deine ZIP-Dateien wurden erstellt und der Download wurde gestartet. Du kannst jetzt z. B. nur Texte anpassen (anderes Land) und erneut exportieren.
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" id="exportModalClose">
          ZurÃ¼ck zu den Eingaben
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    // ==========================================================
    // DV360/Performance-Strategie (WICHTIG):
    // - Preview darf "komfortabel" sein. Export ist entscheidend.
    // - Export-HTML darf KEIN <base> enthalten (hÃ¤ufiger DV360-Fail).
    // - Export-Assets: relative Pfade, alles in ZIP root (index.html + images + Logo.png + /fonts).
    // - Fonts: optional nur woff2 (EXPORT_WOFF_ONLY = true) => weniger KB, schneller.
    // - Images: Upload wird auf JPEG normalisiert + skaliert (maxLongEdge) => weniger KB, weniger Decode-Last.
    // ==========================================================

    // -----------------------
    // Password gate
    // -----------------------
    const GATE_PASSWORD = 'html5';
    const pwGate = document.getElementById('pwGate');
    const pwInput = document.getElementById('pwInput');
    const pwSubmit = document.getElementById('pwSubmit');
    const pwError = document.getElementById('pwError');

    function unlockGate(){
      pwGate.style.display = 'none';
      pwGate.setAttribute('aria-hidden', 'true');
    }
    function showPwError(){
      pwError.style.display = 'block';
      pwInput.classList.add('input-over');
    }
    function clearPwError(){
      pwError.style.display = 'none';
      pwInput.classList.remove('input-over');
    }
    function checkPassword(){
      const val = String(pwInput.value || '').trim();
      if (val === GATE_PASSWORD){
        clearPwError();
        unlockGate();
      } else {
        showPwError();
        pwInput.focus();
        pwInput.select();
      }
    }

    // -----------------------
    // Config
    // -----------------------
    const TEMPLATE_DIR = 'templates';
    const ASSETS_DIR   = 'assets';
    const LOGO_ASSET   = `${ASSETS_DIR}/Logo.png`;

    // DV360-Optimierung: nur woff2 exportieren (optional)
    const EXPORT_WOFF_ONLY = true;

    const FONT_FILES_ALL = [
      'InterstateWGL-Bold.woff',
      'InterstateWGL-Bold.woff2',
      'InterstateWGL-Light.woff',
      'InterstateWGL-Light.woff2',
      'InterstateWGL-Regular.woff',
      'InterstateWGL-Regular.woff2',
    ].map(f => `${ASSETS_DIR}/fonts/${f}`);

    const FONT_FILES = EXPORT_WOFF_ONLY
      ? FONT_FILES_ALL.filter(u => u.endsWith('.woff2'))
      : FONT_FILES_ALL;

    // -----------------------
    // Image conversion settings (Upload)
    // -----------------------
    // DV360: weniger Decode/Memory => kleinere JPGs
    const IMAGE_IMPORT = {
      maxLongEdge: 1800,
      quality: 0.82,
      background: '#ffffff'
    };

    // -----------------------
    // Limits
    // -----------------------
    const TEXT_LIMITS = {
      headline: 25,
      subline: 30,
      ctaText: 17
    };

    const IMPR_TAG = `<img src="https://tagm.tchibo.de/ai.aspx?extProvId=300&extProvApi=129768&extPu=tchibo-dv360&extLi=\${INSERTION_ORDER_ID}&extPm=\${CAMPAIGN_ID}&extCr=\${CREATIVE_ID}&adslotid=\${PUBLISHER_ID}&gdpr=\${GDPR}&gdpr_consent=\${GDPR_CONSENT_312}" style="display:none">`;

    // -----------------------
    // Theme presets
    // -----------------------
    const THEMES = {
      standard: { key:'standard', label:'Standard', headlineColor:null, sublineColor:null, ctaAccentColor:null },
      sale:     { key:'sale',     label:'Sale',     headlineColor:'#BE2D2F', sublineColor:'#1b1b1b', ctaAccentColor:'#BE2D2F' },
      tchibocard:{key:'tchibocard',label:'Tchibocard',headlineColor:'#004266', sublineColor:'#1b1b1b', ctaAccentColor:'#004266' }
    };

    // -----------------------
    // State
    // uploadedImages: { name:'1.jpg', blob:Blob, url:ObjectURL, original:'...' }
    // -----------------------
    let selectedFormats = [];
    let uploadedImages = [];
    let appData = {
      headline: 'Bereit fÃ¼r deine Ziele?',
      subline: 'Sport Outfits entdecken!',
      ctaText: 'Jetzt shoppen',
      landingUrl: '',
      zipName: '',
      themeKey: 'standard'
    };

    function getActiveTheme(){
      return THEMES[appData.themeKey] || THEMES.standard;
    }

    // -----------------------
    // DOM refs
    // -----------------------
    const stage = document.getElementById('stage');
    const previewGrid = document.getElementById('previewGrid');
    const detailNameEl = document.getElementById('detailName');
    const detailTemplateEl = document.getElementById('detailTemplate');
    const detailClickTagEl = document.getElementById('detailClickTag');
    const detailImprTagEl = document.getElementById('detailImprTag');

    const templateSelect = document.getElementById('templateSelect');
    const templateMeta = document.getElementById('templateMeta');
    const dotHeadline = document.getElementById('dotHeadline');
    const dotSubline = document.getElementById('dotSubline');
    const dotCta = document.getElementById('dotCta');

    const exportModal = document.getElementById('exportModal');
    const exportModalCloseBtn = document.getElementById('exportModalClose');
    const exportModalBackdrop = document.getElementById('exportModalBackdrop');

    function showExportModal(){
      exportModal.classList.add('open');
      exportModal.setAttribute('aria-hidden', 'false');
    }
    function hideExportModal(){
      exportModal.classList.remove('open');
      exportModal.setAttribute('aria-hidden', 'true');
    }

    // -----------------------
    // Preview HTML URLs (Blob) - IMPORTANT (fix for blob loading in iframes)
    // -----------------------
    let previewHtmlUrls = [];
    function revokePreviewHtmlUrls(){
      previewHtmlUrls.forEach(u => URL.revokeObjectURL(u));
      previewHtmlUrls = [];
    }

    // -----------------------
    // Helpers
    // -----------------------
    function showStep(stepNumber){
      document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
      const t = document.getElementById(`step${stepNumber}`);
      if (t) t.classList.add('active');
    }

    function escapeJs(str){
      return String(str)
        .replaceAll('\\', '\\\\')
        .replaceAll('"', '\\"')
        .replaceAll('\n', '\\n');
    }

    function parseFormat(format){
      const [w, h] = format.split('x').map(n => parseInt(n, 10));
      return { w, h };
    }

    // âœ… Preview-only: base helps templates refer to assets/ in generator environment
    // ðŸš« Export MUST NOT add <base> (DV360 safety)
    function injectPreviewBase(html){
      if (/<base\s/i.test(html)) return html;
      return html.replace(/<\/head>/i, `  <base href="./${ASSETS_DIR}/">\n</head>`);
    }

    function sanitizeFilePart(name){
      const s = String(name || '').trim();
      const cleaned = s
        .replace(/\s+/g, '_')
        .replace(/[^\w.\-]+/g, '_')
        .replace(/^_+|_+$/g, '');
      return cleaned || 'banner';
    }

    function renumberImages(){
      uploadedImages.forEach((img, i) => img.name = `${i + 1}.jpg`);
    }

    function revokeAllObjectUrls(){
      uploadedImages.forEach(img => { if (img.url) URL.revokeObjectURL(img.url); });
    }

    // -----------------------
    // JPEG-Konvertierung (Upload Normalisierung)
    // -----------------------
    async function convertToJpegBlob(file, {
      maxLongEdge = 1800,
      quality = 0.82,
      background = '#ffffff'
    } = {}){
      const bitmap = await createImageBitmap(file);

      const w = bitmap.width;
      const h = bitmap.height;

      const longEdge = Math.max(w, h);
      const scale = longEdge > maxLongEdge ? (maxLongEdge / longEdge) : 1;

      const targetW = Math.max(1, Math.round(w * scale));
      const targetH = Math.max(1, Math.round(h * scale));

      const canvas = document.createElement('canvas');
      canvas.width = targetW;
      canvas.height = targetH;

      const ctx = canvas.getContext('2d', { alpha: false });

      ctx.fillStyle = background;
      ctx.fillRect(0, 0, targetW, targetH);
      ctx.drawImage(bitmap, 0, 0, targetW, targetH);

      const blob = await new Promise((resolve) => {
        canvas.toBlob(resolve, 'image/jpeg', quality);
      });

      if (!blob) throw new Error('JPEG conversion failed (toBlob returned null)');
      return blob;
    }

    // -----------------------
    // Character counter
    // -----------------------
    function updateCharUI(inputEl, hintEl, max){
      const len = (inputEl.value || '').length;
      hintEl.textContent = `${len}/${max} Zeichen`;
      const over = len > max;

      hintEl.classList.toggle('over', over);
      inputEl.classList.toggle('input-over', over);
    }

    function bindCharLimit(inputId, hintId, max, onChange){
      const inputEl = document.getElementById(inputId);
      const hintEl = document.getElementById(hintId);

      const handler = () => {
        onChange(inputEl.value);
        updateCharUI(inputEl, hintEl, max);
      };

      inputEl.addEventListener('input', handler);
      handler();
    }

    // -----------------------
    // URL / ClickTag Builder
    // -----------------------
    function normalizeLandingUrl(raw){
      let url = String(raw || '').trim();
      if (!url) return '';

      const lower = url.toLowerCase();
      const hasProtocol = /^https?:\/\//i.test(url);

      if (!hasProtocol){
        if (lower === 'tchibo.de' || lower.startsWith('tchibo.de/')){
          url = 'https://www.tchibo.de' + url.slice('tchibo.de'.length);
        } else if (lower === 'www.tchibo.de' || lower.startsWith('www.tchibo.de/')){
          url = 'https://www.tchibo.de' + url.slice('www.tchibo.de'.length);
        } else {
          url = 'https://' + url;
        }
      } else {
        url = url.replace(/^https?:\/\/tchibo\.de/i, 'https://www.tchibo.de');
        url = url.replace(/^https?:\/\/www\.tchibo\.de/i, 'https://www.tchibo.de');
      }
      return url;
    }

    function appendUtmParams(url){
      const u = new URL(url);
      if (!u.searchParams.has('utm_source')) u.searchParams.set('utm_source', 'dbm');
      if (!u.searchParams.has('utm_medium')) u.searchParams.set('utm_medium', 'cpm');
      return u.toString();
    }

    function buildTchiboClickTagUnencoded(landingUrlWithUtm){
      const base = 'https://tagm.tchibo.de/cl.aspx';
      const params =
        'extProvId=300' +
        '&extProvApi=129768' +
        '&extPu=tchibo-dv360' +
        '&extLi=${INSERTION_ORDER_ID}' +
        '&extPm=${CAMPAIGN_ID}' +
        '&extCr=${CREATIVE_ID}' +
        '&adslotid=${PUBLISHER_ID}' +
        '&gdpr=${GDPR}' +
        '&gdpr_consent=${GDPR_CONSENT_312}' +
        '&url=' + landingUrlWithUtm;

      return `${base}?${params}`;
    }

    function getFinalClickTag(){
      const normalized = normalizeLandingUrl(appData.landingUrl);
      if (!normalized) return '';
      try{
        const withUtm = appendUtmParams(normalized);
        return buildTchiboClickTagUnencoded(withUtm);
      } catch {
        return '';
      }
    }

    // -----------------------
    // Theme vars injection
    // -----------------------
    function upsertGeneratorVar(html, varName, valueStr){
      const re = new RegExp(`var\\s+${varName}\\s*=\\s*".*?";`, 's');
      if (re.test(html)){
        return html.replace(re, `var ${varName} = "${escapeJs(valueStr)}";`);
      }
      return html;
    }

    function injectThemeVarsNearGeneratorBlock(html){
      const theme = getActiveTheme();
      const anchorRe = /var\s+CTA_TEXT\s*=\s*".*?";/s;
      if (!anchorRe.test(html)) return html;
      if (/var\s+THEME_KEY\s*=/.test(html)) return html;

      const insert =
`\n    // ====== THEME VARS (vom Generator) ======\n` +
`    var THEME_KEY = "${escapeJs(theme.key)}";\n` +
`    var THEME_HEADLINE_COLOR = "${escapeJs(theme.headlineColor || '')}";\n` +
`    var THEME_SUBLINE_COLOR  = "${escapeJs(theme.sublineColor || '')}";\n` +
`    var THEME_CTA_ACCENT     = "${escapeJs(theme.ctaAccentColor || '')}";\n`;

      return html.replace(anchorRe, (m) => m + insert);
    }

    // -----------------------
    // Template variable replacement
    // - Preview: IMAGE_LIST = ObjectURLs
    // - Export : IMAGE_LIST = ["1.jpg","2.jpg"...]
    // -----------------------
    function replaceTemplateVars(html, { mode }){
      html = html.replace(/var\s+HEADLINE\s*=\s*".*?";/s, `var HEADLINE = "${escapeJs(appData.headline)}";`);
      html = html.replace(/var\s+SUBLINE\s*=\s*".*?";/s,  `var SUBLINE  = "${escapeJs(appData.subline)}";`);
      html = html.replace(/var\s+CTA_TEXT\s*=\s*".*?";/s, `var CTA_TEXT = "${escapeJs(appData.ctaText)}";`);

      const finalClickTag = getFinalClickTag();
      html = html.replace(/var\s+clickTag\s*=\s*".*?";/s, `var clickTag = "${escapeJs(finalClickTag)}";`);

      html = injectThemeVarsNearGeneratorBlock(html);

      const t = getActiveTheme();
      html = upsertGeneratorVar(html, 'THEME_KEY', t.key);
      html = upsertGeneratorVar(html, 'THEME_HEADLINE_COLOR', t.headlineColor || '');
      html = upsertGeneratorVar(html, 'THEME_SUBLINE_COLOR', t.sublineColor || '');
      html = upsertGeneratorVar(html, 'THEME_CTA_ACCENT', t.ctaAccentColor || '');

      if (uploadedImages.length > 0){
        const list = (mode === 'preview')
          ? uploadedImages.map(img => `"${img.url}"`).join(',\n      ')
          : uploadedImages.map(img => `"${img.name}"`).join(',\n      ');

        html = html.replace(/var\s+IMAGE_LIST\s*=\s*\[[\s\S]*?\];/s, `var IMAGE_LIST = [\n      ${list}\n    ];`);
      }
      return html;
    }

    async function fetchText(url){
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return await res.text();
    }

    async function addBinaryToZip(zip, zipPath, url){
      const res = await fetch(url);
      if (!res.ok){
        console.warn(`Asset nicht ladbar: ${url} (HTTP ${res.status})`);
        return;
      }
      const buf = await res.arrayBuffer();
      zip.file(zipPath, buf);
    }

    function getOrderedFormatsForPreview(formats){
      const order = ['300x600','300x250','970x250'];
      return [...formats].sort((a,b) => order.indexOf(a) - order.indexOf(b));
    }

    function applyPreviewLayoutClass(formats){
      previewGrid.classList.remove('layout-1','layout-2','layout-3');
      if (formats.length <= 1) previewGrid.classList.add('layout-1');
      else if (formats.length === 2) previewGrid.classList.add('layout-2');
      else previewGrid.classList.add('layout-3');
    }

    // -----------------------
    // Template selector UI
    // -----------------------
    function paintTemplateUI(){
      const t = getActiveTheme();

      if (t.key === 'standard'){
        templateMeta.textContent = 'Farben: Standard (wie aktuell)';
      } else if (t.key === 'sale'){
        templateMeta.textContent = `Farben: Sale â€” Headline ${t.headlineColor}, Subline ${t.sublineColor}, CTA-Akzent ${t.ctaAccentColor}`;
      } else {
        templateMeta.textContent = `Farben: Tchibocard â€” Headline ${t.headlineColor}, Subline ${t.sublineColor}, CTA-Akzent ${t.ctaAccentColor}`;
      }

      dotHeadline.style.background = t.headlineColor || '#9ca3af';
      dotSubline.style.background  = t.sublineColor  || '#9ca3af';
      dotCta.style.background      = t.ctaAccentColor || '#9ca3af';
    }

    // -----------------------
    // Step 1: Format selection
    // -----------------------
    const formatCheckboxes = document.querySelectorAll('input[type="checkbox"]');
    const nextButton1 = document.getElementById('nextStep1');

    formatCheckboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        selectedFormats = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(x => x.value);
        nextButton1.disabled = selectedFormats.length === 0;
      });
    });

    nextButton1.addEventListener('click', () => showStep(2));

    // -----------------------
    // Step 2: Image upload + reorder (DnD)
    // -----------------------
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('imageUpload');
    const uploadedContainer = document.getElementById('uploadedImages');

    let dragSrcIndex = null;

    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', async (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      await handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', async (e) => await handleFiles(e.target.files));

    async function handleFiles(files){
      for (const file of Array.from(files)){
        if (!file.type.startsWith('image/')) continue;

        try{
          const blob = await convertToJpegBlob(file, IMAGE_IMPORT);
          const url = URL.createObjectURL(blob);

          uploadedImages.push({
            name: '',
            blob,
            url,
            original: file.name
          });

          renumberImages();
          updateImageDisplay();

        } catch (err){
          console.warn('Bild konnte nicht verarbeitet werden:', file.name, err);
          alert(`Bild konnte nicht verarbeitet werden: ${file.name}\n\nHinweis: HEIC/HEIF wird je nach Browser nicht unterstÃ¼tzt. Bitte ggf. als JPG/PNG exportieren.`);
        }
      }
    }

    function moveImage(fromIndex, toIndex){
      if (fromIndex === toIndex) return;
      const item = uploadedImages.splice(fromIndex, 1)[0];
      uploadedImages.splice(toIndex, 0, item);
      renumberImages();
      updateImageDisplay();
    }

    function updateImageDisplay(){
      uploadedContainer.innerHTML = '';

      uploadedImages.forEach((img, index) => {
        const div = document.createElement('div');
        div.className = 'uploaded-image';
        div.setAttribute('draggable', 'true');
        div.dataset.index = String(index);

        div.innerHTML = `
          <img src="${img.url}" alt="Bild ${index + 1}">
          <div class="number">${index + 1}.jpg</div>
          <button class="remove" type="button" data-index="${index}" aria-label="Bild entfernen">Ã—</button>
        `;

        div.querySelector('button.remove').addEventListener('click', (ev) => {
          ev.stopPropagation();
          removeImage(index);
        });

        div.addEventListener('dragstart', (e) => {
          dragSrcIndex = index;
          div.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          try { e.dataTransfer.setData('text/plain', String(index)); } catch {}
        });

        div.addEventListener('dragend', () => {
          dragSrcIndex = null;
          div.classList.remove('dragging');
          uploadedContainer.querySelectorAll('.uploaded-image.dragover').forEach(el => el.classList.remove('dragover'));
        });

        div.addEventListener('dragover', (e) => {
          e.preventDefault();
          div.classList.add('dragover');
          e.dataTransfer.dropEffect = 'move';
        });

        div.addEventListener('dragleave', () => div.classList.remove('dragover'));

        div.addEventListener('drop', (e) => {
          e.preventDefault();
          div.classList.remove('dragover');

          const targetIndex = Number(div.dataset.index);
          const from = dragSrcIndex;

          if (Number.isInteger(from) && from !== null && !Number.isNaN(targetIndex) && from !== targetIndex){
            const adjustedTarget = (from < targetIndex) ? targetIndex - 1 : targetIndex;
            moveImage(from, adjustedTarget);
          }
        });

        uploadedContainer.appendChild(div);
      });
    }

    function removeImage(index){
      const item = uploadedImages[index];
      if (item?.url) URL.revokeObjectURL(item.url);
      uploadedImages.splice(index, 1);
      renumberImages();
      updateImageDisplay();
    }

    // -----------------------
    // Live preview (responsive scaling)
    // IMPORTANT FIX:
    // - Use iframe.src = blob(html) instead of srcdoc
    //   => prevents "Not allowed to load local resource: blob:..."
    // -----------------------
    async function generatePreviews(){
      // cleanup old preview html URLs (avoid leaks)
      revokePreviewHtmlUrls();

      previewGrid.innerHTML = '';

      const nm = sanitizeFilePart(appData.zipName);
      detailNameEl.textContent = nm || '-';

      const t = getActiveTheme();
      detailTemplateEl.textContent = t.label || '-';

      detailClickTagEl.textContent = getFinalClickTag() || '-';
      detailImprTagEl.textContent = IMPR_TAG;

      const formats = getOrderedFormatsForPreview(selectedFormats);
      applyPreviewLayoutClass(formats);

      for (const format of formats){
        const { w, h } = parseFormat(format);
        const maxH = (format === '300x600') ? 680 : 340;

        let html;
        try{
          html = await fetchText(`${TEMPLATE_DIR}/${format}.html`);
        } catch (e){
          const err = document.createElement('div');
          err.className = 'preview-item';
          err.dataset.format = format;
          err.innerHTML = `<h4>${format}</h4><div style="padding:10px;color:#b91c1c;">Template nicht ladbar<br>${String(e)}</div>`;
          previewGrid.appendChild(err);
          continue;
        }

        // Preview-only base for assets in generator environment
        html = injectPreviewBase(html);

        // Replace vars (IMAGE_LIST becomes objectURLs here)
        html = replaceTemplateVars(html, { mode: 'preview' });

        const item = document.createElement('div');
        item.className = 'preview-item';
        item.dataset.format = format;

        const title = document.createElement('h4');
        title.textContent = format;
        item.appendChild(title);

        const viewport = document.createElement('div');
        viewport.className = 'iframe-viewport';
        viewport.style.width = '100%';
        viewport.style.height = '12px';

        const iframe = document.createElement('iframe');
        iframe.width = w;
        iframe.height = h;

        // sandbox ok
        iframe.setAttribute('sandbox','allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox');
        iframe.style.transformOrigin = '0 0';

        // âœ… FIX: load preview HTML via blob URL (not srcdoc)
        const htmlBlob = new Blob([html], { type: 'text/html' });
        const htmlUrl = URL.createObjectURL(htmlBlob);
        previewHtmlUrls.push(htmlUrl);
        iframe.src = htmlUrl;

        viewport.appendChild(iframe);
        item.appendChild(viewport);
        previewGrid.appendChild(item);

        await new Promise(requestAnimationFrame);

        const availW = viewport.clientWidth;
        const scale = Math.min(1, availW / w, maxH / h);

        viewport.style.height = `${Math.ceil(h * scale)}px`;
        iframe.style.transform = `scale(${scale})`;
      }
    }

    // -----------------------
    // Export: ZIP (DV360-safe)
    // - No <base>
    // - IMAGE_LIST => ["1.jpg","2.jpg",...]
    // - Files at zip root: index.html, 1.jpg..., Logo.png, /fonts/*.woff2
    // -----------------------
    async function exportBanners(){
      const baseName = sanitizeFilePart(appData.zipName);

      // Optional: small sanity check for DV360 (not hard-fail)
      if (uploadedImages.length === 0){
        alert('Bitte lade mindestens 1 Bild hoch.');
        return;
      }

      for (const format of selectedFormats){
        const zip = new JSZip();

        let templateContent;
        try{
          templateContent = await fetchText(`${TEMPLATE_DIR}/${format}.html`);
        } catch (e){
          console.error(`Template load failed (${format}):`, e);
          alert(`Template ${format}.html nicht gefunden oder nicht ladbar!`);
          continue;
        }

        // DV360: ensure we do NOT inject <base> in export
        templateContent = replaceTemplateVars(templateContent, { mode: 'export' });
        zip.file('index.html', templateContent);

        // Images: blobs => zip root (1.jpg, 2.jpg, ...)
        uploadedImages.forEach(img => {
          zip.file(img.name, img.blob);
        });

        // Logo
        await addBinaryToZip(zip, 'Logo.png', LOGO_ASSET);

        // Fonts
        for (const url of FONT_FILES){
          const filename = url.split('/').pop();
          await addBinaryToZip(zip, `fonts/${filename}`, url);
        }

        const blob = await zip.generateAsync({ type:'blob' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${format}_${baseName}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);

        await new Promise(r => setTimeout(r, 250));
      }
    }

    // -----------------------
    // UI bindings
    // -----------------------
    document.addEventListener('DOMContentLoaded', () => {
      // Password gate
      pwInput.addEventListener('input', clearPwError);
      pwSubmit.addEventListener('click', checkPassword);
      pwInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') checkPassword();
      });
      pwInput.focus();

      // Template selector
      templateSelect.value = appData.themeKey;
      templateSelect.addEventListener('change', async (e) => {
        appData.themeKey = String(e.target.value || 'standard');
        paintTemplateUI();
        if (stage.classList.contains('has-preview')){
          await generatePreviews();
        }
      });
      paintTemplateUI();

      // Character-limited inputs
      bindCharLimit('headline', 'headlineHint', TEXT_LIMITS.headline, v => appData.headline = v);
      bindCharLimit('subline',  'sublineHint',  TEXT_LIMITS.subline,  v => appData.subline  = v);
      bindCharLimit('ctaText',  'ctaHint',      TEXT_LIMITS.ctaText,  v => appData.ctaText  = v);

      // Other inputs
      document.getElementById('clickUrl').addEventListener('input', e => appData.landingUrl = e.target.value);
      document.getElementById('zipName').addEventListener('input', e => appData.zipName = e.target.value);

      // Back
      document.getElementById('backStep1').addEventListener('click', () => showStep(1));

      // Preview
      document.getElementById('createPreview').addEventListener('click', async () => {
        const finalClick = getFinalClickTag();
        const nmRaw = String(appData.zipName || '').trim();

        if (!finalClick){
          alert('Bitte gib eine gÃ¼ltige Ziel-URL ein!');
          return;
        }
        if (!nmRaw){
          alert('Bitte gib ein Naming fÃ¼r die ZIP-Datei ein!');
          return;
        }
        if (selectedFormats.length === 0){
          alert('Bitte wÃ¤hle mindestens ein Format aus.');
          return;
        }
        if (uploadedImages.length === 0){
          alert('Bitte lade mindestens 1 Bild hoch.');
          return;
        }

        stage.classList.add('has-preview');
        await generatePreviews();
      });

      // Toggle preview visibility
      document.getElementById('togglePreviewBtn').addEventListener('click', () => {
        stage.classList.remove('has-preview');
        // optional: free preview html urls when hiding
        revokePreviewHtmlUrls();
      });

      // Export modal close
      exportModalCloseBtn.addEventListener('click', hideExportModal);
      exportModalBackdrop.addEventListener('click', hideExportModal);
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && exportModal.classList.contains('open')) hideExportModal();
      });

      // Export
      const exportBtn = document.getElementById('exportBanners');
      exportBtn.addEventListener('click', async () => {
        const finalClick = getFinalClickTag();
        const nmRaw = String(appData.zipName || '').trim();

        if (!finalClick){
          alert('Bitte gib eine gÃ¼ltige Ziel-URL ein!');
          return;
        }
        if (!nmRaw){
          alert('Bitte gib ein Naming fÃ¼r die ZIP-Datei ein!');
          return;
        }
        if (selectedFormats.length === 0){
          alert('Bitte wÃ¤hle mindestens ein Format aus.');
          return;
        }
        if (uploadedImages.length === 0){
          alert('Bitte lade mindestens 1 Bild hoch.');
          return;
        }

        const oldText = exportBtn.innerHTML;
        exportBtn.disabled = true;
        exportBtn.innerHTML = `Export lÃ¤uft... <i class="fas fa-spinner fa-spin"></i>`;

        try{
          await exportBanners();
          showExportModal();
        } finally {
          exportBtn.disabled = false;
          exportBtn.innerHTML = oldText;
        }
      });

      // Cleanup: object URLs freigeben
      window.addEventListener('beforeunload', () => {
        revokePreviewHtmlUrls();
        revokeAllObjectUrls();
      });
    });
  </script>
</body>
</html>
