<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HTML5 Banner Generator</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <style>
    :root{
      --primary:#667eea;
      --success:#4facfe;
      --danger:#ff6b6b;
      --dark:#2c3e50;
      --white:#ffffff;
      --shadow:0 10px 30px rgba(0,0,0,0.10);
      --border-radius:12px;

      --bg1:#667eea;
      --bg2:#764ba2;
    }

    *{margin:0;padding:0;box-sizing:border-box;}

    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      min-height:100vh;
      color:var(--dark);
      line-height:1.6;
    }

    .container{
      max-width:1500px;
      margin:0 auto;
      padding:20px;
    }

    .header{
      text-align:center;
      margin-bottom:30px;
      color:var(--white);
    }

    .header h1{
      font-size:2.5rem;
      font-weight:700;
      margin-bottom:10px;
      text-shadow:0 2px 10px rgba(0,0,0,0.2);
    }

    .card{
      background:var(--white);
      border-radius:var(--border-radius);
      padding:26px;
      box-shadow:var(--shadow);
      transition:transform .25s ease, box-shadow .25s ease;
    }
    .card:hover{ transform:translateY(-2px); }

    .step-content{ display:none; }
    .step-content.active{ display:block; animation:fadeIn .35s ease; }
    @keyframes fadeIn{ from{opacity:0;} to{opacity:1;} }

    /* ---------- Buttons ---------- */
    .button-group{
      display:flex;
      gap:15px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:18px;
    }

    .btn{
      padding:12px 30px;
      border:none;
      border-radius:25px;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      transition:all .25s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .btn-primary{
      background: linear-gradient(135deg, var(--primary), #5a6fd8);
      color:var(--white);
    }
    .btn-primary:hover:not(:disabled){
      transform:translateY(-2px);
      box-shadow:0 10px 25px rgba(102,126,234,.30);
    }

    .btn-secondary{ background:#6c757d; color:var(--white); }
    .btn-secondary:hover{ background:#545b62; transform:translateY(-2px); }

    .btn-success{
      background: linear-gradient(135deg, var(--success), #00b4db);
      color:var(--white);
    }
    .btn-success:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 25px rgba(79,172,254,.30);
    }

    /* ---------- Step 1: Formats ---------- */
    .format-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
      gap:20px;
      margin-top:18px;
      margin-bottom:22px;
    }

    .format-card{
      position:relative;
      cursor:pointer;
      border-radius:var(--border-radius);
      border:3px solid #e0e0e0;
      background:#f8f9fa;
      overflow:hidden;
      transition:all .25s ease;
    }
    .format-card:hover{ transform:translateY(-3px); box-shadow:var(--shadow); }
    .format-card input[type="checkbox"]{ display:none; }

    .format-preview{ padding:20px; text-align:center; transition:all .25s ease; }

    .preview-box{
      background:var(--white);
      border-radius:10px;
      padding:20px;
      margin-bottom:15px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      border:2px dashed #ddd;
      min-height:90px;
      color:#1f2430;
    }

    .checkmark{
      position:absolute;
      top:10px;
      right:10px;
      background: var(--success);
      color:var(--white);
      width:32px;
      height:32px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      transform:scale(.6);
      transition:all .25s ease;
      box-shadow:0 10px 25px rgba(0,0,0,.15);
    }

    /* Checked State */
    .format-card input[type="checkbox"]:checked + .format-preview{
      background: linear-gradient(135deg, #5B6CFF, #35C6FF);
      color:#fff;
    }
    .format-card input[type="checkbox"]:checked + .format-preview .preview-box{
      background: rgba(10, 15, 30, 0.42);
      border:1px solid rgba(255,255,255,0.40);
      box-shadow: 0 10px 25px rgba(0,0,0,0.18), inset 0 1px 0 rgba(255,255,255,0.18);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color:#fff;
    }
    .format-card input[type="checkbox"]:checked + .format-preview .preview-box span{
      color:#fff;
      font-weight:900;
      letter-spacing:.2px;
      text-shadow:0 2px 10px rgba(0,0,0,.25);
    }
    .format-card input[type="checkbox"]:checked + .format-preview .preview-box small{
      color: rgba(255,255,255,0.92);
      text-shadow:0 2px 10px rgba(0,0,0,.20);
    }
    .format-card:has(input[type="checkbox"]:checked){
      border-color: rgba(53,198,255,0.95);
      box-shadow: 0 14px 35px rgba(0,0,0,0.18);
    }
    .format-card input[type="checkbox"]:checked ~ .checkmark{
      opacity:1;
      transform:scale(1);
    }

    /* ---------- Step 2: Stage ---------- */
    .stage{
      width:100%;
      display:flex;
      justify-content:center;
    }

    .stage-inner{
      width:100%;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      gap:22px;
    }

    .left-panels{
      display:grid;
      grid-template-columns: repeat(3, minmax(280px, 340px));
      gap:22px;
      justify-content:center;
      align-items:stretch;
      transition:transform .35s ease;
    }

    .left-panels .card{
      height: 100%;
      min-height: 520px;
      display:flex;
      flex-direction:column;
    }

    /* Upload */
    .upload-area{
      border:3px dashed #ddd;
      border-radius:var(--border-radius);
      padding:32px;
      text-align:center;
      cursor:pointer;
      transition:all .25s ease;
      position:relative;
      background:#f8f9fa;
    }
    .upload-area:hover, .upload-area.dragover{
      border-color:var(--primary);
      background: rgba(102,126,234,0.06);
    }
    .upload-area input[type="file"]{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
    }
    .upload-area i{
      font-size:3rem;
      color:var(--primary);
      margin-bottom:12px;
    }

    .uploaded-images{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(92px, 1fr));
      gap:10px;
      margin-top:16px;
    }
    .uploaded-image{
      position:relative;
      aspect-ratio:1;
      border-radius:10px;
      overflow:hidden;
      background:#f0f0f0;
      cursor:grab;
      outline:2px solid transparent;
      transition: outline .15s ease, transform .15s ease, opacity .15s ease;
    }
    .uploaded-image:active{ cursor:grabbing; }
    .uploaded-image.dragging{
      opacity:.55;
      transform: scale(.98);
    }
    .uploaded-image.dragover{
      outline:2px dashed rgba(102,126,234,0.9);
      outline-offset:-2px;
    }
    .uploaded-image img{
      width:100%;
      height:100%;
      object-fit:cover;
      pointer-events:none;
      user-select:none;
    }
    .uploaded-image .remove{
      position:absolute;
      top:6px;
      right:6px;
      background:var(--danger);
      color:var(--white);
      border:none;
      border-radius:50%;
      width:26px;
      height:26px;
      cursor:pointer;
      font-size:.85rem;
      z-index:2;
    }
    .uploaded-image .number{
      position:absolute;
      bottom:6px;
      left:6px;
      background:var(--primary);
      color:var(--white);
      padding:2px 6px;
      border-radius:6px;
      font-size:.80rem;
      font-weight:800;
      z-index:2;
    }

    /* Inputs */
    .input-group{ margin-top:14px; }
    .input-group label{
      display:block;
      margin-bottom:8px;
      font-weight:700;
      color:var(--dark);
    }
    .input-group input{
      width:100%;
      padding:12px 14px;
      border:2px solid #e0e0e0;
      border-radius:10px;
      font-size:1rem;
      transition:all .25s ease;
    }
    .input-group input:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(102,126,234,0.12);
    }

    /* Character hint / warning */
    .char-hint{
      margin-top:6px;
      font-size:.72rem; /* geändert: nur Schriftgröße kleiner */
      color:#6b7280;
      display:flex;
      justify-content:flex-end;
      gap:10px;
      user-select:none;
    }
    .char-hint.over{
      color: var(--danger);
      font-weight:800;
    }
    .input-over{
      border-color: var(--danger) !important;
      box-shadow:0 0 0 3px rgba(255,107,107,0.18) !important;
    }

    /* Preview Panel */
    .preview-panel{
      width:0;
      max-width:0;
      opacity:0;
      pointer-events:none;
      transition: width .35s ease, max-width .35s ease, opacity .25s ease;
    }

    .stage.has-preview .left-panels{
      transform: translateX(-12px);
    }

    .stage.has-preview .preview-panel{
      width: 100%;
      max-width: clamp(520px, 52vw, 980px); /* geändert: rechte Kachel responsiv etwas größer */
      opacity:1;
      pointer-events:auto;
    }

    .preview-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .preview-head .title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      font-size:1.15rem;
    }

    .toggle-preview{
      border:1px solid rgba(102,126,234,.25);
      background:#f3f6ff;
      color:#3c4cb4;
      padding:8px 14px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
    }

    .preview-grid{
      display:grid;
      gap:16px;
      align-items:start;
      justify-items:stretch;
    }

    .preview-grid.layout-1{
      grid-template-columns: 1fr;
      justify-items:center;
    }

    .preview-grid.layout-2{
      grid-template-columns: 1fr 1fr;
    }

    /* Layout 3: gleiche Positionen, aber rechte Spalte breiter (970x250 wird größer, bleibt an gleicher Stelle) */
    .preview-grid.layout-3{
      grid-template-columns: 1fr 1.35fr; /* geändert */
      grid-template-areas:
        "a b"
        "a c";
    }
    .preview-grid.layout-3 .preview-item[data-format="300x600"]{ grid-area:a; }
    .preview-grid.layout-3 .preview-item[data-format="300x250"]{ grid-area:b; }
    .preview-grid.layout-3 .preview-item[data-format="970x250"]{ grid-area:c; }

    .preview-item{
      background:#f7f9ff;
      border:1px solid rgba(0,0,0,0.06);
      border-radius:14px;
      padding:12px;
      overflow:hidden;
      box-shadow: 0 10px 24px rgba(0,0,0,0.06);
    }

    .preview-item h4{
      margin:4px 0 10px 0;
      text-align:center;
      font-weight:900;
      color:#1f2430;
    }

    .iframe-viewport{
      width:100%;
      border-radius:12px;
      overflow:hidden;
      background:#fff;
      border:1px solid rgba(0,0,0,0.08);
    }
    .iframe-viewport iframe{
      border:0;
      display:block;
      background:transparent;
      transform-origin:0 0;
    }

    /* Details accordion */
    details.preview-details{
      margin-top:14px;
      background:#fff;
      border:1px solid rgba(0,0,0,0.08);
      border-radius:14px;
      overflow:hidden;
    }
    details.preview-details > summary{
      cursor:pointer;
      list-style:none;
      padding:14px 16px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:#fbfcff;
    }
    details.preview-details > summary::-webkit-details-marker{ display:none; }
    .details-body{
      padding:14px 16px;
      font-size:.95rem;
      color:#334155;
      border-top:1px solid rgba(0,0,0,0.06);
      word-break:break-word;
    }
    .details-label{ font-weight:900; color:#111827; }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:.88rem;
      background:#f3f4f6;
      padding:10px 12px;
      border-radius:10px;
      margin-top:8px;
      overflow:auto;
      white-space:pre-wrap;
    }

    /* ---------- Export Modal ---------- */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:18px;
    }
    .modal.open{ display:flex; }
    .modal-backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(2px);
    }
    .modal-card{
      position:relative;
      width: min(520px, 100%);
      background:#fff;
      border-radius:16px;
      box-shadow: 0 18px 55px rgba(0,0,0,0.25);
      padding:22px;
      z-index:1;
    }
    .modal-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      font-size:1.1rem;
      margin-bottom:10px;
      color:#111827;
    }
    .modal-body{
      color:#374151;
      font-size:0.98rem;
      line-height:1.55;
    }
    .modal-actions{
      display:flex;
      gap:12px;
      justify-content:flex-end;
      margin-top:16px;
      flex-wrap:wrap;
    }

    /* ---------- Responsive ---------- */
    @media (max-width: 1260px){
      .left-panels{
        grid-template-columns: repeat(2, minmax(280px, 360px));
      }
      .left-panels .card{ min-height: 480px; }
      .stage.has-preview .preview-panel{
        max-width: clamp(480px, 54vw, 900px); /* angepasst: ebenfalls etwas größer */
      }
      .left-panels .card:nth-child(3){
        grid-column: 1 / -1;
        min-height: 340px;
      }
    }

    @media (max-width: 980px){
      .stage-inner{
        flex-direction:column;
        align-items:center;
      }
      .left-panels{
        grid-template-columns: 1fr;
        width:min(520px, 100%);
      }
      .left-panels .card{
        min-height: unset;
      }
      .preview-panel{
        width:100% !important;
        max-width: min(920px, 100%) !important;
        opacity:1 !important;
        pointer-events:auto !important;
      }
      .stage.has-preview .left-panels{ transform:none; }

      .preview-grid.layout-2,
      .preview-grid.layout-3{
        grid-template-columns: 1fr;
        grid-template-areas: none;
      }
      .preview-grid.layout-3 .preview-item{ grid-area:auto; }
    }

    @media (max-width: 600px){
      .header h1{ font-size:2rem; }
      .btn{ width:100%; justify-content:center; }
      .modal-actions{ justify-content:stretch; }
      .modal-actions .btn{ width:100%; justify-content:center; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="header">
      <h1><i class="fas fa-magic"></i> HTML5 Banner Generator</h1>
      <p>Erstelle professionelle Display-Banner für Google Ads &amp; DV360</p>
    </header>

    <!-- Step 1 -->
    <div class="step-content active" id="step1">
      <div class="card">
        <h2><i class="fas fa-th-large"></i> Banner-Formate auswählen</h2>

        <div class="format-grid">
          <label class="format-card" for="format-300x250">
            <input type="checkbox" id="format-300x250" value="300x250">
            <div class="format-preview">
              <div class="preview-box">
                <span style="font-weight:900;font-size:1.2em;">300×250</span>
                <small>Medium Rectangle</small>
              </div>
            </div>
            <span class="checkmark"><i class="fas fa-check"></i></span>
          </label>

          <label class="format-card" for="format-300x600">
            <input type="checkbox" id="format-300x600" value="300x600">
            <div class="format-preview">
              <div class="preview-box">
                <span style="font-weight:900;font-size:1.2em;">300×600</span>
                <small>Half Page</small>
              </div>
            </div>
            <span class="checkmark"><i class="fas fa-check"></i></span>
          </label>

          <label class="format-card" for="format-970x250">
            <input type="checkbox" id="format-970x250" value="970x250">
            <div class="format-preview">
              <div class="preview-box">
                <span style="font-weight:900;font-size:1.2em;">970×250</span>
                <small>Billboard</small>
              </div>
            </div>
            <span class="checkmark"><i class="fas fa-check"></i></span>
          </label>
        </div>

        <div class="button-group">
          <button class="btn btn-primary" id="nextStep1" disabled>
            Weiter <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="step-content" id="step2">
      <div class="stage" id="stage">
        <div class="stage-inner">

          <!-- Left 3 cards -->
          <div class="left-panels">

            <div class="card">
              <h3><i class="fas fa-images"></i> Bilder hochladen</h3>
              <div class="upload-area" id="uploadArea" style="margin-top:14px;">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Bilder hier hinziehen oder klicken</p>
                <p style="font-size:0.9em;color:#666;margin-top:10px;">
                  Reihenfolge per Drag &amp; Drop ändern (wird neu zu 1.jpg, 2.jpg, ... durchnummeriert)
                </p>
                <input type="file" id="imageUpload" multiple accept="image/*">
              </div>
              <div class="uploaded-images" id="uploadedImages"></div>
            </div>

            <div class="card">
              <h3><i class="fas fa-font"></i> Texte anpassen</h3>

              <div class="input-group">
                <label for="headline">Headline</label>
                <input type="text" id="headline" value="Bereit für deine Ziele?">
                <div class="char-hint" id="headlineHint"></div>
              </div>

              <div class="input-group">
                <label for="subline">Subline</label>
                <input type="text" id="subline" value="Sport Outfits entdecken!">
                <div class="char-hint" id="sublineHint"></div>
              </div>

              <div class="input-group">
                <label for="ctaText">CTA Text</label>
                <input type="text" id="ctaText" value="Jetzt shoppen">
                <div class="char-hint" id="ctaHint"></div>
              </div>
            </div>

            <div class="card">
              <h3><i class="fas fa-link"></i> Click-URL</h3>

              <div class="input-group">
                <label for="zipName">Naming (für ZIP-Datei)</label>
                <input type="text" id="zipName" placeholder="z.B. KW02_BackToGym" required>
              </div>

              <div class="input-group">
                <label for="clickUrl">Ziel-URL</label>
                <input type="url" id="clickUrl" placeholder="https://example.com" required>
              </div>

              <p style="margin-top:14px;font-size:0.9em;color:#6b7280;">
                Hinweis: <b>utm_source=dbm</b> &amp; <b>utm_medium=cpm</b> werden automatisch ergänzt.
              </p>
            </div>

          </div>

          <!-- Preview panel -->
          <div class="preview-panel">
            <div class="card">
              <div class="preview-head">
                <div class="title"><i class="fas fa-eye"></i> Vorschau</div>
                <button class="toggle-preview" id="togglePreviewBtn" type="button">
                  Ausblenden
                </button>
              </div>

              <div class="preview-grid" id="previewGrid"></div>

              <details class="preview-details" id="previewDetails">
                <summary>
                  Details
                  <i class="fas fa-chevron-down" aria-hidden="true"></i>
                </summary>
                <div class="details-body">
                  <div class="details-label">Naming</div>
                  <div id="detailName">-</div>

                  <div class="details-label" style="margin-top:12px;">Final clickTag</div>
                  <div class="mono" id="detailClickTag">-</div>

                  <div class="details-label" style="margin-top:12px;">Impr.-Tag</div>
                  <div class="mono" id="detailImprTag">-</div>
                </div>
              </details>
            </div>
          </div>

        </div>
      </div>

      <div class="button-group">
        <button class="btn btn-secondary" id="backStep1">
          <i class="fas fa-arrow-left"></i> Zurück
        </button>
        <button class="btn btn-primary" id="createPreview">
          Vorschau erstellen <i class="fas fa-eye"></i>
        </button>
        <button class="btn btn-success" id="exportBanners">
          Export starten <i class="fas fa-download"></i>
        </button>
      </div>
    </div>

  </div>

  <!-- Export Success Modal -->
  <div class="modal" id="exportModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-backdrop" id="exportModalBackdrop"></div>
    <div class="modal-card">
      <div class="modal-title">
        <i class="fas fa-check-circle" style="color:var(--success);"></i>
        Download erstellt
      </div>
      <div class="modal-body">
        Deine ZIP-Dateien wurden erstellt und der Download wurde gestartet. Du kannst jetzt z. B. nur Texte anpassen (anderes Land) und erneut exportieren.
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" id="exportModalClose">
          Zurück zu den Eingaben
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    // -----------------------
    // Config (Ordnerstruktur)
    // -----------------------
    const TEMPLATE_DIR = 'templates';
    const ASSETS_DIR   = 'assets';
    const LOGO_ASSET   = `${ASSETS_DIR}/Logo.png`;

    const FONT_FILES = [
      'InterstateWGL-Bold.woff',
      'InterstateWGL-Bold.woff2',
      'InterstateWGL-Light.woff',
      'InterstateWGL-Light.woff2',
      'InterstateWGL-Regular.woff',
      'InterstateWGL-Regular.woff2',
    ].map(f => `${ASSETS_DIR}/fonts/${f}`);

    // -----------------------
    // Limits
    // -----------------------
    const TEXT_LIMITS = {
      headline: 25,
      subline: 30,
      ctaText: 17
    };

    // Statischer Impr.-Tag (soll als Code angezeigt werden, nicht gerendert)
    const IMPR_TAG = `<img src="https://tagm.tchibo.de/ai.aspx?extProvId=300&extProvApi=129768&extPu=tchibo-dv360&extLi=\${INSERTION_ORDER_ID}&extPm=\${CAMPAIGN_ID}&extCr=\${CREATIVE_ID}&adslotid=\${PUBLISHER_ID}&gdpr=\${GDPR}&gdpr_consent=\${GDPR_CONSENT_312}" style="display:none">`;

    // -----------------------
    // State
    // -----------------------
    let selectedFormats = [];
    let uploadedImages = [];
    let appData = {
      headline: 'Bereit für deine Ziele?',
      subline: 'Sport Outfits entdecken!',
      ctaText: 'Jetzt shoppen',
      landingUrl: '',
      zipName: ''
    };

    // -----------------------
    // DOM refs
    // -----------------------
    const stage = document.getElementById('stage');
    const previewGrid = document.getElementById('previewGrid');
    const detailNameEl = document.getElementById('detailName');
    const detailClickTagEl = document.getElementById('detailClickTag');
    const detailImprTagEl = document.getElementById('detailImprTag');

    // Modal
    const exportModal = document.getElementById('exportModal');
    const exportModalCloseBtn = document.getElementById('exportModalClose');
    const exportModalBackdrop = document.getElementById('exportModalBackdrop');

    function showExportModal(){
      exportModal.classList.add('open');
      exportModal.setAttribute('aria-hidden', 'false');
    }
    function hideExportModal(){
      exportModal.classList.remove('open');
      exportModal.setAttribute('aria-hidden', 'true');
    }

    // -----------------------
    // Helpers
    // -----------------------
    function showStep(stepNumber){
      document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
      const t = document.getElementById(`step${stepNumber}`);
      if (t) t.classList.add('active');
    }

    function escapeJs(str){
      return String(str)
        .replaceAll('\\', '\\\\')
        .replaceAll('"', '\\"')
        .replaceAll('\n', '\\n');
    }

    function parseFormat(format){
      const [w, h] = format.split('x').map(n => parseInt(n, 10));
      return { w, h };
    }

    function injectPreviewBase(html){
      if (/<base\s/i.test(html)) return html;
      return html.replace(/<\/head>/i, `  <base href="./${ASSETS_DIR}/">\n</head>`);
    }

    function sanitizeFilePart(name){
      const s = String(name || '').trim();
      const cleaned = s
        .replace(/\s+/g, '_')
        .replace(/[^\w.\-]+/g, '_')
        .replace(/^_+|_+$/g, '');
      return cleaned || 'banner';
    }

    function renumberImages(){
      uploadedImages.forEach((img, i) => img.name = `${i + 1}.jpg`);
    }

    // -----------------------
    // Character counter
    // -----------------------
    function updateCharUI(inputEl, hintEl, max){
      const len = (inputEl.value || '').length; // inkl. Leerzeichen
      hintEl.textContent = `${len}/${max} Zeichen`;
      const over = len > max;

      hintEl.classList.toggle('over', over);
      inputEl.classList.toggle('input-over', over);
    }

    function bindCharLimit(inputId, hintId, max, onChange){
      const inputEl = document.getElementById(inputId);
      const hintEl = document.getElementById(hintId);

      const handler = () => {
        onChange(inputEl.value);
        updateCharUI(inputEl, hintEl, max);
      };

      inputEl.addEventListener('input', handler);
      // initial
      handler();
    }

    // -----------------------
    // URL / ClickTag Builder
    // -----------------------
    function normalizeLandingUrl(raw){
      let url = String(raw || '').trim();
      if (!url) return '';

      const lower = url.toLowerCase();
      const hasProtocol = /^https?:\/\//i.test(url);

      if (!hasProtocol){
        if (lower === 'tchibo.de' || lower.startsWith('tchibo.de/')){
          url = 'https://www.tchibo.de' + url.slice('tchibo.de'.length);
        } else if (lower === 'www.tchibo.de' || lower.startsWith('www.tchibo.de/')){
          url = 'https://www.tchibo.de' + url.slice('www.tchibo.de'.length);
        } else {
          url = 'https://' + url;
        }
      } else {
        url = url.replace(/^https?:\/\/tchibo\.de/i, 'https://www.tchibo.de');
        url = url.replace(/^https?:\/\/www\.tchibo\.de/i, 'https://www.tchibo.de');
      }
      return url;
    }

    function appendUtmParams(url){
      const u = new URL(url);
      if (!u.searchParams.has('utm_source')) u.searchParams.set('utm_source', 'dbm');
      if (!u.searchParams.has('utm_medium')) u.searchParams.set('utm_medium', 'cpm');
      return u.toString();
    }

    function buildTchiboClickTagUnencoded(landingUrlWithUtm){
      const base = 'https://tagm.tchibo.de/cl.aspx';
      const params =
        'extProvId=300' +
        '&extProvApi=129768' +
        '&extPu=tchibo-dv360' +
        '&extLi=${INSERTION_ORDER_ID}' +
        '&extPm=${CAMPAIGN_ID}' +
        '&extCr=${CREATIVE_ID}' +
        '&adslotid=${PUBLISHER_ID}' +
        '&gdpr=${GDPR}' +
        '&gdpr_consent=${GDPR_CONSENT_312}' +
        '&url=' + landingUrlWithUtm;

      return `${base}?${params}`;
    }

    function getFinalClickTag(){
      const normalized = normalizeLandingUrl(appData.landingUrl);
      if (!normalized) return '';
      try{
        const withUtm = appendUtmParams(normalized);
        return buildTchiboClickTagUnencoded(withUtm);
      } catch {
        return '';
      }
    }

    // -----------------------
    // Template variable replacement
    // -----------------------
    function replaceTemplateVars(html, { mode }){
      html = html.replace(/var\s+HEADLINE\s*=\s*".*?";/s, `var HEADLINE = "${escapeJs(appData.headline)}";`);
      html = html.replace(/var\s+SUBLINE\s*=\s*".*?";/s,  `var SUBLINE  = "${escapeJs(appData.subline)}";`);
      html = html.replace(/var\s+CTA_TEXT\s*=\s*".*?";/s, `var CTA_TEXT = "${escapeJs(appData.ctaText)}";`);

      const finalClickTag = getFinalClickTag();
      html = html.replace(/var\s+clickTag\s*=\s*".*?";/s, `var clickTag = "${escapeJs(finalClickTag)}";`);

      if (uploadedImages.length > 0){
        const list = (mode === 'preview')
          ? uploadedImages.map(img => `"${img.data}"`).join(',\n      ')
          : uploadedImages.map(img => `"${img.name}"`).join(',\n      ');

        html = html.replace(/var\s+IMAGE_LIST\s*=\s*\[[\s\S]*?\];/s, `var IMAGE_LIST = [\n      ${list}\n    ];`);
      }
      return html;
    }

    async function fetchText(url){
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return await res.text();
    }

    async function addBinaryToZip(zip, zipPath, url){
      const res = await fetch(url);
      if (!res.ok){
        console.warn(`Asset nicht ladbar: ${url} (HTTP ${res.status})`);
        return;
      }
      const buf = await res.arrayBuffer();
      zip.file(zipPath, buf);
    }

    function getOrderedFormatsForPreview(formats){
      const order = ['300x600','300x250','970x250'];
      return [...formats].sort((a,b) => order.indexOf(a) - order.indexOf(b));
    }

    function applyPreviewLayoutClass(formats){
      previewGrid.classList.remove('layout-1','layout-2','layout-3');
      if (formats.length <= 1) previewGrid.classList.add('layout-1');
      else if (formats.length === 2) previewGrid.classList.add('layout-2');
      else previewGrid.classList.add('layout-3');
    }

    // -----------------------
    // Step 1: Format selection
    // -----------------------
    const formatCheckboxes = document.querySelectorAll('input[type="checkbox"]');
    const nextButton1 = document.getElementById('nextStep1');

    formatCheckboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        selectedFormats = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(x => x.value);
        nextButton1.disabled = selectedFormats.length === 0;
      });
    });

    nextButton1.addEventListener('click', () => showStep(2));

    // -----------------------
    // Step 2: Image upload + reorder (DnD)
    // -----------------------
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('imageUpload');
    const uploadedContainer = document.getElementById('uploadedImages');

    let dragSrcIndex = null;

    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    function handleFiles(files){
      Array.from(files).forEach(file => {
        if (!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedImages.push({
            name: `${uploadedImages.length + 1}.jpg`,
            data: e.target.result,
            original: file.name
          });
          renumberImages();
          updateImageDisplay();
        };
        reader.readAsDataURL(file);
      });
    }

    function moveImage(fromIndex, toIndex){
      if (fromIndex === toIndex) return;
      const item = uploadedImages.splice(fromIndex, 1)[0];
      // Insert BEFORE target index (damit "auf 1 ziehen" => wird 1)
      uploadedImages.splice(toIndex, 0, item);
      renumberImages();
      updateImageDisplay();
    }

    function updateImageDisplay(){
      uploadedContainer.innerHTML = '';

      uploadedImages.forEach((img, index) => {
        const div = document.createElement('div');
        div.className = 'uploaded-image';
        div.setAttribute('draggable', 'true');
        div.dataset.index = String(index);

        div.innerHTML = `
          <img src="${img.data}" alt="Bild ${index + 1}">
          <div class="number">${index + 1}.jpg</div>
          <button class="remove" type="button" data-index="${index}" aria-label="Bild entfernen">×</button>
        `;

        // Remove
        div.querySelector('button.remove').addEventListener('click', (ev) => {
          ev.stopPropagation();
          removeImage(index);
        });

        // Drag events
        div.addEventListener('dragstart', (e) => {
          dragSrcIndex = index;
          div.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          try { e.dataTransfer.setData('text/plain', String(index)); } catch {}
        });

        div.addEventListener('dragend', () => {
          dragSrcIndex = null;
          div.classList.remove('dragging');
          uploadedContainer.querySelectorAll('.uploaded-image.dragover').forEach(el => el.classList.remove('dragover'));
        });

        div.addEventListener('dragover', (e) => {
          e.preventDefault();
          div.classList.add('dragover');
          e.dataTransfer.dropEffect = 'move';
        });

        div.addEventListener('dragleave', () => div.classList.remove('dragover'));

        div.addEventListener('drop', (e) => {
          e.preventDefault();
          div.classList.remove('dragover');

          const targetIndex = Number(div.dataset.index);
          const from = dragSrcIndex;

          if (Number.isInteger(from) && from !== null && !Number.isNaN(targetIndex) && from !== targetIndex){
            const adjustedTarget = (from < targetIndex) ? targetIndex - 1 : targetIndex;
            moveImage(from, adjustedTarget);
          }
        });

        uploadedContainer.appendChild(div);
      });
    }

    function removeImage(index){
      uploadedImages.splice(index, 1);
      renumberImages();
      updateImageDisplay();
    }

    // -----------------------
    // Live preview (responsive scaling)
    // -----------------------
    async function generatePreviews(){
      previewGrid.innerHTML = '';

      const nm = sanitizeFilePart(appData.zipName);
      detailNameEl.textContent = nm || '-';
      detailClickTagEl.textContent = getFinalClickTag() || '-';
      detailImprTagEl.textContent = IMPR_TAG;

      const formats = getOrderedFormatsForPreview(selectedFormats);
      applyPreviewLayoutClass(formats);

      for (const format of formats){
        const { w, h } = parseFormat(format);

        const maxH = (format === '300x600') ? 680 : 340;

        let html;
        try{
          html = await fetchText(`${TEMPLATE_DIR}/${format}.html`);
        } catch (e){
          const err = document.createElement('div');
          err.className = 'preview-item';
          err.dataset.format = format;
          err.innerHTML = `<h4>${format}</h4><div style="padding:10px;color:#b91c1c;">Template nicht ladbar<br>${String(e)}</div>`;
          previewGrid.appendChild(err);
          continue;
        }

        html = injectPreviewBase(html);
        html = replaceTemplateVars(html, { mode: 'preview' });

        const item = document.createElement('div');
        item.className = 'preview-item';
        item.dataset.format = format;

        const title = document.createElement('h4');
        title.textContent = format;
        item.appendChild(title);

        const viewport = document.createElement('div');
        viewport.className = 'iframe-viewport';
        viewport.style.width = '100%';
        viewport.style.height = '12px';

        const iframe = document.createElement('iframe');
        iframe.width = w;
        iframe.height = h;
        iframe.setAttribute('sandbox','allow-scripts allow-popups allow-popups-to-escape-sandbox');
        iframe.style.transformOrigin = '0 0';
        iframe.srcdoc = html;

        viewport.appendChild(iframe);
        item.appendChild(viewport);
        previewGrid.appendChild(item);

        await new Promise(requestAnimationFrame);

        const availW = viewport.clientWidth;
        const scale = Math.min(1, availW / w, maxH / h);

        viewport.style.height = `${Math.ceil(h * scale)}px`;
        iframe.style.transform = `scale(${scale})`;
      }
    }

    // -----------------------
    // Export: ZIP
    // -----------------------
    async function exportBanners(){
      const baseName = sanitizeFilePart(appData.zipName);

      for (const format of selectedFormats){
        const zip = new JSZip();

        let templateContent;
        try{
          templateContent = await fetchText(`${TEMPLATE_DIR}/${format}.html`);
        } catch (e){
          console.error(`Template load failed (${format}):`, e);
          alert(`Template ${format}.html nicht gefunden oder nicht ladbar!`);
          continue;
        }

        templateContent = replaceTemplateVars(templateContent, { mode: 'export' });
        zip.file('index.html', templateContent);

        // Images (geordnet, entsprechend aktueller Reihenfolge)
        uploadedImages.forEach(img => {
          const base64Data = img.data.split(',')[1];
          zip.file(img.name, base64Data, { base64:true });
        });

        // Logo + fonts
        await addBinaryToZip(zip, 'Logo.png', LOGO_ASSET);
        for (const url of FONT_FILES){
          const filename = url.split('/').pop();
          await addBinaryToZip(zip, `fonts/${filename}`, url);
        }

        const blob = await zip.generateAsync({ type:'blob' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${format}_${baseName}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);

        await new Promise(r => setTimeout(r, 250));
      }
    }

    // -----------------------
    // UI bindings
    // -----------------------
    document.addEventListener('DOMContentLoaded', () => {
      // Character-limited inputs (Warnung, aber nicht blockieren)
      bindCharLimit('headline', 'headlineHint', TEXT_LIMITS.headline, v => appData.headline = v);
      bindCharLimit('subline',  'sublineHint',  TEXT_LIMITS.subline,  v => appData.subline  = v);
      bindCharLimit('ctaText',  'ctaHint',      TEXT_LIMITS.ctaText,  v => appData.ctaText  = v);

      // Other inputs
      document.getElementById('clickUrl').addEventListener('input', e => appData.landingUrl = e.target.value);
      document.getElementById('zipName').addEventListener('input', e => appData.zipName = e.target.value);

      // Back
      document.getElementById('backStep1').addEventListener('click', () => showStep(1));

      // Preview button
      document.getElementById('createPreview').addEventListener('click', async () => {
        const finalClick = getFinalClickTag();
        const nmRaw = String(appData.zipName || '').trim();

        if (!finalClick){
          alert('Bitte gib eine gültige Ziel-URL ein!');
          return;
        }
        if (!nmRaw){
          alert('Bitte gib ein Naming für die ZIP-Datei ein!');
          return;
        }
        if (selectedFormats.length === 0){
          alert('Bitte wähle mindestens ein Format aus.');
          return;
        }

        stage.classList.add('has-preview');
        await generatePreviews();
      });

      // Toggle preview visibility
      document.getElementById('togglePreviewBtn').addEventListener('click', () => {
        stage.classList.remove('has-preview');
      });

      // Export modal close
      exportModalCloseBtn.addEventListener('click', hideExportModal);
      exportModalBackdrop.addEventListener('click', hideExportModal);
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && exportModal.classList.contains('open')) hideExportModal();
      });

      // Export
      const exportBtn = document.getElementById('exportBanners');
      exportBtn.addEventListener('click', async () => {
        const finalClick = getFinalClickTag();
        const nmRaw = String(appData.zipName || '').trim();

        if (!finalClick){
          alert('Bitte gib eine gültige Ziel-URL ein!');
          return;
        }
        if (!nmRaw){
          alert('Bitte gib ein Naming für die ZIP-Datei ein!');
          return;
        }
        if (selectedFormats.length === 0){
          alert('Bitte wähle mindestens ein Format aus.');
          return;
        }

        const oldText = exportBtn.innerHTML;
        exportBtn.disabled = true;
        exportBtn.innerHTML = `Export läuft... <i class="fas fa-spinner fa-spin"></i>`;

        try{
          await exportBanners();
          showExportModal();
        } finally {
          exportBtn.disabled = false;
          exportBtn.innerHTML = oldText;
        }
      });
    });
  </script>
</body>
</html>
