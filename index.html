<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HTML5 Banner Generator</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <style>
    :root {
      --primary: #667eea;
      --success: #4facfe;
      --danger: #ff6b6b;
      --dark: #2c3e50;
      --white: #ffffff;
      --shadow: 0 10px 30px rgba(0,0,0,0.1);
      --border-radius: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: var(--dark);
      line-height: 1.6;
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    .header {
      text-align: center;
      margin-bottom: 40px;
      color: var(--white);
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .card {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .card:hover { transform: translateY(-2px); }

    .step-content { display: none; }
    .step-content.active { display: block; animation: fadeIn 0.5s; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .format-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .format-card {
      position: relative;
      cursor: pointer;
      border-radius: var(--border-radius);
      border: 3px solid #e0e0e0;
      background: #f8f9fa;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .format-card:hover { transform: translateY(-3px); box-shadow: var(--shadow); }
    .format-card input[type="checkbox"] { display: none; }

    .format-card input[type="checkbox"]:checked + .format-preview {
      background: linear-gradient(135deg, var(--primary), var(--success));
      color: var(--white);
    }

    .format-card input[type="checkbox"]:checked ~ .checkmark {
      opacity: 1;
      transform: scale(1);
    }

    .format-preview { padding: 20px; text-align: center; transition: all 0.3s ease; }

    .preview-box {
      background: var(--white);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border: 2px dashed #ddd;
      min-height: 80px;
    }

    .checkmark {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--success);
      color: var(--white);
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0);
      transition: all 0.3s ease;
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .input-group { margin-bottom: 20px; }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }

    .input-group input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .input-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .upload-area {
      border: 3px dashed #ddd;
      border-radius: var(--border-radius);
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      background: #f8f9fa;
    }

    .upload-area:hover, .upload-area.dragover {
      border-color: var(--primary);
      background: rgba(102, 126, 234, 0.05);
    }

    .upload-area input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .upload-area i {
      font-size: 3rem;
      color: var(--primary);
      margin-bottom: 15px;
    }

    .uploaded-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 20px;
    }

    .uploaded-image {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      background: #f0f0f0;
    }

    .uploaded-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .uploaded-image .remove {
      position: absolute;
      top: 5px;
      right: 5px;
      background: var(--danger);
      color: var(--white);
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .uploaded-image .number {
      position: absolute;
      bottom: 5px;
      left: 5px;
      background: var(--primary);
      color: var(--white);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #5a6fd8);
      color: var(--white);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary { background: #6c757d; color: var(--white); }
    .btn-secondary:hover { background: #545b62; transform: translateY(-2px); }

    .btn-success {
      background: linear-gradient(135deg, var(--success), #00b4db);
      color: var(--white);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(79, 172, 254, 0.3);
    }

    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* Preview Container */
    #previewContainer {
      min-height: 200px;
      width: 100%;
      display: block;
      visibility: visible;
    }

    .banner-preview {
      border: 1px solid #ddd;
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .banner-preview h4 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.2em;
    }

    @media (max-width: 768px) {
      .container { padding: 10px; }
      .header h1 { font-size: 2rem; }
      .format-grid, .input-grid { grid-template-columns: 1fr; }
      .btn { width: 100%; justify-content: center; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="header">
      <h1><i class="fas fa-magic"></i> HTML5 Banner Generator</h1>
      <p>Erstelle professionelle Display-Banner für Google Ads &amp; DV360</p>
    </header>

    <!-- Step 1: Format Selection -->
<div class="step-content active" id="step1">
  <div class="card">
    <h2><i class="fas fa-th-large"></i> Banner-Formate auswählen</h2>

    <div class="format-grid">
      <label class="format-card" for="format-300x250">
        <input type="checkbox" id="format-300x250" value="300x250">
        <div class="format-preview">
          <div class="preview-box">
            <span style="font-weight: bold; font-size: 1.2em;">300×250</span>
            <small>Medium Rectangle</small>
          </div>
        </div>
        <span class="checkmark"><i class="fas fa-check"></i></span>
      </label>

      <label class="format-card" for="format-300x600">
        <input type="checkbox" id="format-300x600" value="300x600">
        <div class="format-preview">
          <div class="preview-box">
            <span style="font-weight: bold; font-size: 1.2em;">300×600</span>
            <small>Half Page</small>
          </div>
        </div>
        <span class="checkmark"><i class="fas fa-check"></i></span>
      </label>

      <label class="format-card" for="format-970x250">
        <input type="checkbox" id="format-970x250" value="970x250">
        <div class="format-preview">
          <div class="preview-box">
            <span style="font-weight: bold; font-size: 1.2em;">970×250</span>
            <small>Billboard</small>
          </div>
        </div>
        <span class="checkmark"><i class="fas fa-check"></i></span>
      </label>
    </div>

    <div class="button-group">
      <button class="btn btn-primary" id="nextStep1" disabled>
        Weiter <i class="fas fa-arrow-right"></i>
      </button>
    </div>
  </div>
</div>

<!-- Step 2: Content Input -->
<div class="step-content" id="step2">
  <div class="input-grid">
    <div class="card">
      <h3><i class="fas fa-images"></i> Bilder hochladen</h3>
      <div class="upload-area" id="uploadArea">
        <i class="fas fa-cloud-upload-alt"></i>
        <p>Bilder hier hinziehen oder klicken</p>
        <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
          Werden automatisch zu 1.jpg, 2.jpg, etc. umbenannt
        </p>
        <input type="file" id="imageUpload" multiple accept="image/*">
      </div>
      <div class="uploaded-images" id="uploadedImages"></div>
    </div>

    <div class="card">
      <h3><i class="fas fa-font"></i> Texte anpassen</h3>
      <div class="input-group">
        <label for="headline">Headline</label>
        <input type="text" id="headline" value="Bereit für deine Ziele?" maxlength="50">
      </div>
      <div class="input-group">
        <label for="subline">Subline</label>
        <input type="text" id="subline" value="Sport Outfits entdecken!" maxlength="50">
      </div>
      <div class="input-group">
        <label for="ctaText">CTA Text</label>
        <input type="text" id="ctaText" value="Jetzt shoppen" maxlength="20">
      </div>
    </div>

    <div class="card">
      <h3><i class="fas fa-link"></i> Click-URL</h3>
      <div class="input-group">
        <label for="clickUrl">Ziel-URL</label>
        <input type="url" id="clickUrl" placeholder="https://example.com" required>
      </div>
    </div>
  </div>

  <div class="button-group">
    <button class="btn btn-secondary" id="backStep1">
      <i class="fas fa-arrow-left"></i> Zurück
    </button>
    <button class="btn btn-primary" id="createPreview">
      Vorschau erstellen <i class="fas fa-eye"></i>
    </button>
  </div>
</div>

<!-- Step 3: Preview -->
<div class="step-content" id="step3">
  <div class="card">
    <h2><i class="fas fa-eye"></i> Banner-Vorschau</h2>
    <div id="previewContainer"></div>
  </div>

  <div class="button-group">
    <button class="btn btn-secondary" id="backStep2">
      <i class="fas fa-arrow-left"></i> Zurück
    </button>
    <button class="btn btn-success" id="exportBanners">
      Export starten <i class="fas fa-download"></i>
    </button>
  </div>
</div>

<!-- Step 4: Export Status -->
<div class="step-content" id="step4">
  <div class="card">
    <h2><i class="fas fa-download"></i> Export Status</h2>
    <div id="exportStatus" style="text-align: center; padding: 20px;">
      <div style="margin-bottom: 20px;">
        <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success);"></i>
      </div>
      <h3>Export erfolgreich!</h3>
      <p>Deine Banner wurden als ZIP-Dateien heruntergeladen.</p>
    </div>
  </div>

  <div class="button-group">
    <button class="btn btn-primary" id="startOver">
      <i class="fas fa-plus"></i> Neue Banner erstellen
    </button>
  </div>
</div>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    // Globale Variablen
    let selectedFormats = [];
    let uploadedImages = [];
    let appData = {
      headline: 'Bereit für deine Ziele?',
      subline: 'Sport Outfits entdecken!',
      ctaText: 'Jetzt shoppen',
      clickUrl: ''
    };

    function showStep(stepNumber) {
      console.log('Wechsle zu Step:', stepNumber);

      document.querySelectorAll('.step-content').forEach(step => {
        step.classList.remove('active');
      });

      const targetStep = document.getElementById(`step${stepNumber}`);
      if (targetStep) {
        targetStep.classList.add('active');
        console.log('Zeige:', targetStep.id);
      } else {
        console.error('Step nicht gefunden:', `step${stepNumber}`);
      }
    }

    // Format Selection Logic
    const formatCheckboxes = document.querySelectorAll('input[type="checkbox"]');
    const nextButton1 = document.getElementById('nextStep1');

    formatCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        selectedFormats = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
          .map(cb => cb.value);

        nextButton1.disabled = selectedFormats.length === 0;
      });
    });

    nextButton1.addEventListener('click', function() {
      showStep(2);
    });

    // Image Upload Logic
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('imageUpload');
    const uploadedContainer = document.getElementById('uploadedImages');

    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    function handleFiles(files) {
      Array.from(files).forEach(file => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            uploadedImages.push({
              name: `${uploadedImages.length + 1}.jpg`,
              data: e.target.result,
              original: file.name
            });
            updateImageDisplay();
          };
          reader.readAsDataURL(file);
        }
      });
    }

    function updateImageDisplay() {
      uploadedContainer.innerHTML = '';
      uploadedImages.forEach((img, index) => {
        const div = document.createElement('div');
        div.className = 'uploaded-image';
        div.innerHTML = `
          <img src="${img.data}" alt="Bild ${index + 1}">
          <div class="number">${index + 1}.jpg</div>
          <button class="remove" type="button" onclick="removeImage(${index})">×</button>
        `;
        uploadedContainer.appendChild(div);
      });
    }

    function removeImage(index) {
      uploadedImages.splice(index, 1);
      uploadedImages.forEach((img, newIndex) => {
        img.name = `${newIndex + 1}.jpg`;
      });
      updateImageDisplay();
    }

         async function generatePreviews() {
  console.log('generatePreviews() gestartet');

  const container = document.getElementById('previewContainer');
  container.innerHTML = '';

  for (const format of selectedFormats) {
    const response = await fetch(`templates/${format}.html`);
    if (!response.ok) {
      container.innerHTML += `<div class="banner-preview"><b>Template ${format}.html nicht gefunden</b></div>`;
      continue;
    }

    let html = await response.text();

    // Variablen ersetzen (wie Export)
    html = html.replace(/var HEADLINE = ".*?";/, `var HEADLINE = "${escapeJs(appData.headline)}";`);
    html = html.replace(/var SUBLINE = ".*?";/, `var SUBLINE = "${escapeJs(appData.subline)}";`);
    html = html.replace(/var CTA_TEXT = ".*?";/, `var CTA_TEXT = "${escapeJs(appData.ctaText)}";`);

    const imageList = uploadedImages.map(img => `"${img.name}"`).join(',\n      ');
    html = html.replace(/var IMAGE_LIST = \[[\s\S]*?\];/, `var IMAGE_LIST = [\n      ${imageList}\n    ];`);

    html = html.replace(/var clickTag = ".*?";/, `var clickTag = "${escapeJs(appData.clickUrl)}";`);

    // Preview-Wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'banner-preview';
    wrapper.innerHTML = `<h4 style="margin-bottom:10px">Banner ${format}</h4>`;

    // iFrame
    const iframe = document.createElement('iframe');
    iframe.style.border = '1px solid #ddd';
    iframe.style.borderRadius = '8px';
    iframe.style.width = '100%';
    iframe.style.maxWidth = '980px';
    iframe.style.height = (format === '300x600') ? '640px' : '340px';

    // WICHTIG: Sandbox so, dass Scripts laufen (Animationen im Template)
    iframe.setAttribute('sandbox', 'allow-scripts allow-popups allow-popups-to-escape-sandbox');

    // srcdoc setzen
    iframe.srcdoc = html;

    wrapper.appendChild(iframe);
    container.appendChild(wrapper);
  }

  console.log('Echte Template-Preview erstellt!');
}

// string sicher in "..." im JS
function escapeJs(str) {
  return String(str).replaceAll('\\', '\\\\').replaceAll('"', '\\"').replaceAll('\n', '\\n');
}


    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    async function exportBanners() {
      for (const format of selectedFormats) {
        const zip = new JSZip();

        try {
          const response = await fetch(`templates/${format}.html`);
          if (!response.ok) throw new Error(`HTTP ${response.status} for templates/${format}.html`);

          let templateContent = await response.text();

          // Hinweis: Diese Regex erwartet, dass die Variablen im Template exakt so vorkommen:
          templateContent = templateContent.replace(/var HEADLINE = ".*?";/, `var HEADLINE = "${appData.headline}";`);
          templateContent = templateContent.replace(/var SUBLINE = ".*?";/, `var SUBLINE = "${appData.subline}";`);
          templateContent = templateContent.replace(/var CTA_TEXT = ".*?";/, `var CTA_TEXT = "${appData.ctaText}";`);

          const imageList = uploadedImages.map(img => `"${img.name}"`).join(',\n      ');
          templateContent = templateContent.replace(
            /var IMAGE_LIST = \[[\s\S]*?\];/,
            `var IMAGE_LIST = [\n      ${imageList}\n    ];`
          );

          templateContent = templateContent.replace(/var clickTag = ".*?";/, `var clickTag = "${appData.clickUrl}";`);

          zip.file('index.html', templateContent);

          uploadedImages.forEach(img => {
            const base64Data = img.data.split(',')[1];
            zip.file(img.name, base64Data, { base64: true });
          });

          const content = await zip.generateAsync({ type: 'blob' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(content);
          link.download = `banner-${format}.zip`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(link.href);

          await new Promise(resolve => setTimeout(resolve, 300));
        } catch (error) {
          console.error(`Error loading template ${format}:`, error);
          alert(`Template ${format}.html nicht gefunden oder nicht ladbar!`);
        }
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('headline').addEventListener('input', function() {
        appData.headline = this.value;
      });

      document.getElementById('subline').addEventListener('input', function() {
        appData.subline = this.value;
      });

      document.getElementById('ctaText').addEventListener('input', function() {
        appData.ctaText = this.value;
      });

      document.getElementById('clickUrl').addEventListener('input', function() {
        appData.clickUrl = this.value;
      });

      document.getElementById('backStep1').addEventListener('click', () => showStep(1));

      document.getElementById('createPreview').addEventListener('click', async function() {
      if (!appData.clickUrl) {
        alert('Bitte gib eine gültige URL ein!');
        return;
      }
      showStep(3);
      await generatePreviews();
    });


      document.getElementById('backStep2').addEventListener('click', () => showStep(2));

      document.getElementById('exportBanners').addEventListener('click', async function() {
        await exportBanners();
        showStep(4);
      });

      document.getElementById('startOver').addEventListener('click', function() {
        selectedFormats = [];
        uploadedImages = [];
        appData = {
          headline: 'Bereit für deine Ziele?',
          subline: 'Sport Outfits entdecken!',
          ctaText: 'Jetzt shoppen',
          clickUrl: ''
        };

        formatCheckboxes.forEach(cb => cb.checked = false);
        document.getElementById('uploadedImages').innerHTML = '';
        document.getElementById('clickUrl').value = '';
        document.getElementById('headline').value = appData.headline;
        document.getElementById('subline').value = appData.subline;
        document.getElementById('ctaText').value = appData.ctaText;
        nextButton1.disabled = true;

        document.getElementById('previewContainer').innerHTML = '';

        showStep(1);
      });

      console.log('HTML5 Banner Generator geladen!');
    });
  </script>
</body>
</html>
