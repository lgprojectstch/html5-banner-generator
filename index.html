<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HTML5 Banner Generator</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <style>
    :root {
      --primary: #667eea;
      --success: #4facfe;
      --danger: #ff6b6b;
      --dark: #2c3e50;
      --white: #ffffff;
      --shadow: 0 10px 30px rgba(0,0,0,0.1);
      --border-radius: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: var(--dark);
      line-height: 1.6;
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    .header {
      text-align: center;
      margin-bottom: 40px;
      color: var(--white);
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .card {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .card:hover { transform: translateY(-2px); }

    .step-content { display: none; }
    .step-content.active { display: block; animation: fadeIn 0.5s; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .format-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .format-card {
      position: relative;
      cursor: pointer;
      border-radius: var(--border-radius);
      border: 3px solid #e0e0e0;
      background: #f8f9fa;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .format-card:hover { transform: translateY(-3px); box-shadow: var(--shadow); }
    .format-card input[type="checkbox"] { display: none; }

    .format-card input[type="checkbox"]:checked + .format-preview {
      background: linear-gradient(135deg, var(--primary), var(--success));
      color: var(--white);
    }

    .format-card input[type="checkbox"]:checked ~ .checkmark {
      opacity: 1;
      transform: scale(1);
    }

    .format-preview { padding: 20px; text-align: center; transition: all 0.3s ease; }

    .preview-box {
      background: var(--white);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border: 2px dashed #ddd;
      min-height: 80px;
    }

    .checkmark {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--success);
      color: var(--white);
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0);
      transition: all 0.3s ease;
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .input-group { margin-bottom: 20px; }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }

    .input-group input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .input-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .upload-area {
      border: 3px dashed #ddd;
      border-radius: var(--border-radius);
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      background: #f8f9fa;
    }

    .upload-area:hover, .upload-area.dragover {
      border-color: var(--primary);
      background: rgba(102, 126, 234, 0.05);
    }

    .upload-area input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .upload-area i {
      font-size: 3rem;
      color: var(--primary);
      margin-bottom: 15px;
    }

    .uploaded-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 20px;
    }

    .uploaded-image {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      background: #f0f0f0;
    }

    .uploaded-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .uploaded-image .remove {
      position: absolute;
      top: 5px;
      right: 5px;
      background: var(--danger);
      color: var(--white);
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .uploaded-image .number {
      position: absolute;
      bottom: 5px;
      left: 5px;
      background: var(--primary);
      color: var(--white);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #5a6fd8);
      color: var(--white);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary { background: #6c757d; color: var(--white); }
    .btn-secondary:hover { background: #545b62; transform: translateY(-2px); }

    .btn-success {
      background: linear-gradient(135deg, var(--success), #00b4db);
      color: var(--white);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(79, 172, 254, 0.3);
    }

    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* Preview Container */
    #previewContainer {
      min-height: 200px;
      width: 100%;
      display: block;
    }

   .banner-preview {
  padding: 20px;          /* ok, weil es um den Preview-Block geht */
}

.banner-preview .iframe-viewport {
  margin: 0;              /* kein zusätzlicher Abstand, der irritiert */
}


    .iframe-viewport {
  border: 0;              /* kein Rahmen */
  border-radius: 0;       /* keine Rundung */
  overflow: visible;      /* NICHT clippen */
  background: transparent;
  display: inline-block;
  max-width: 100%;
}

.iframe-viewport iframe {
  border: 0;
  display: block;
  background: transparent;
}


    @media (max-width: 768px) {
      .container { padding: 10px; }
      .header h1 { font-size: 2rem; }
      .format-grid, .input-grid { grid-template-columns: 1fr; }
      .btn { width: 100%; justify-content: center; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="header">
      <h1><i class="fas fa-magic"></i> HTML5 Banner Generator</h1>
      <p>Erstelle professionelle Display-Banner für Google Ads &amp; DV360</p>
    </header>

    <!-- Step 1: Format Selection -->
    <div class="step-content active" id="step1">
      <div class="card">
        <h2><i class="fas fa-th-large"></i> Banner-Formate auswählen</h2>

        <div class="format-grid">
          <label class="format-card" for="format-300x250">
            <input type="checkbox" id="format-300x250" value="300x250">
            <div class="format-preview">
              <div class="preview-box">
                <span style="font-weight: bold; font-size: 1.2em;">300×250</span>
                <small>Medium Rectangle</small>
              </div>
            </div>
            <span class="checkmark"><i class="fas fa-check"></i></span>
          </label>

          <label class="format-card" for="format-300x600">
            <input type="checkbox" id="format-300x600" value="300x600">
            <div class="format-preview">
              <div class="preview-box">
                <span style="font-weight: bold; font-size: 1.2em;">300×600</span>
                <small>Half Page</small>
              </div>
            </div>
            <span class="checkmark"><i class="fas fa-check"></i></span>
          </label>

          <label class="format-card" for="format-970x250">
            <input type="checkbox" id="format-970x250" value="970x250">
            <div class="format-preview">
              <div class="preview-box">
                <span style="font-weight: bold; font-size: 1.2em;">970×250</span>
                <small>Billboard</small>
              </div>
            </div>
            <span class="checkmark"><i class="fas fa-check"></i></span>
          </label>
        </div>

        <div class="button-group">
          <button class="btn btn-primary" id="nextStep1" disabled>
            Weiter <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Step 2: Content Input -->
    <div class="step-content" id="step2">
      <div class="input-grid">
        <div class="card">
          <h3><i class="fas fa-images"></i> Bilder hochladen</h3>
          <div class="upload-area" id="uploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Bilder hier hinziehen oder klicken</p>
            <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
              Werden automatisch zu 1.jpg, 2.jpg, etc. umbenannt
            </p>
            <input type="file" id="imageUpload" multiple accept="image/*">
          </div>
          <div class="uploaded-images" id="uploadedImages"></div>
        </div>

        <div class="card">
          <h3><i class="fas fa-font"></i> Texte anpassen</h3>
          <div class="input-group">
            <label for="headline">Headline</label>
            <input type="text" id="headline" value="Bereit für deine Ziele?" maxlength="50">
          </div>
          <div class="input-group">
            <label for="subline">Subline</label>
            <input type="text" id="subline" value="Sport Outfits entdecken!" maxlength="50">
          </div>
          <div class="input-group">
            <label for="ctaText">CTA Text</label>
            <input type="text" id="ctaText" value="Jetzt shoppen" maxlength="20">
          </div>
        </div>

        <div class="card">
          <h3><i class="fas fa-link"></i> Click-URL</h3>
          <div class="input-group">
            <label for="clickUrl">Ziel-URL</label>
            <input type="url" id="clickUrl" placeholder="https://example.com" required>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button class="btn btn-secondary" id="backStep1">
          <i class="fas fa-arrow-left"></i> Zurück
        </button>
        <button class="btn btn-primary" id="createPreview">
          Vorschau erstellen <i class="fas fa-eye"></i>
        </button>
      </div>
    </div>

    <!-- Step 3: Preview -->
    <div class="step-content" id="step3">
      <div class="card">
        <h2><i class="fas fa-eye"></i> Banner-Vorschau</h2>
        <div id="previewContainer"></div>
      </div>

      <div class="button-group">
        <button class="btn btn-secondary" id="backStep2">
          <i class="fas fa-arrow-left"></i> Zurück
        </button>
        <button class="btn btn-success" id="exportBanners">
          Export starten <i class="fas fa-download"></i>
        </button>
      </div>
    </div>

    <!-- Step 4: Export Status -->
    <div class="step-content" id="step4">
      <div class="card">
        <h2><i class="fas fa-download"></i> Export Status</h2>
        <div id="exportStatus" style="text-align: center; padding: 20px;">
          <div style="margin-bottom: 20px;">
            <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success);"></i>
          </div>
          <h3>Export erfolgreich!</h3>
          <p>Deine Banner wurden als ZIP-Dateien heruntergeladen.</p>
        </div>
      </div>

      <div class="button-group">
        <button class="btn btn-primary" id="startOver">
          <i class="fas fa-plus"></i> Neue Banner erstellen
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    // -----------------------
    // Config (Ordnerstruktur)
    // -----------------------
    const TEMPLATE_DIR = 'templates';       // templates/300x250.html ...
    const ASSETS_DIR   = 'assets';          // assets/Logo.png, assets/fonts/...
    const LOGO_ASSET   = `${ASSETS_DIR}/Logo.png`;

    // Fonts in assets/fonts (Browser kann nicht "listen" -> Liste fix)
    const FONT_FILES = [
      'Interstate WGL Bold.woff',
      'Interstate WGL Bold.woff2',
      'Interstate WGL Light.woff',
      'Interstate WGL Light.woff2',
      'Interstate WGL Regular.woff',
      'Interstate WGL Regular.woff2',
    ].map(f => `${ASSETS_DIR}/fonts/${f}`);

    // -----------------------
    // State
    // -----------------------
    let selectedFormats = [];
    let uploadedImages = [];
    let appData = {
    headline: 'Bereit für deine Ziele?',
    subline: 'Sport Outfits entdecken!',
    ctaText: 'Jetzt shoppen',
    landingUrl: '' // statt clickUrl
    };


    // -----------------------
    // Helpers
    // -----------------------
    function showStep(stepNumber) {
      document.querySelectorAll('.step-content').forEach(step => step.classList.remove('active'));
      const targetStep = document.getElementById(`step${stepNumber}`);
      if (targetStep) targetStep.classList.add('active');
    }

    function escapeJs(str) {
      return String(str)
        .replaceAll('\\', '\\\\')
        .replaceAll('"', '\\"')
        .replaceAll('\n', '\\n');
    }

    function parseFormat(format) {
      const [w, h] = format.split('x').map(n => parseInt(n, 10));
      return { w, h };
    }

    function computeScale(w, h) {
      // Ziel: gut sichtbar im Generator, aber nicht zu groß
      const maxW = 980;
      const maxH = 700;
      return Math.min(1, maxW / w, maxH / h);
    }

    function injectPreviewBase(html) {
      // Für Preview: Template referenziert "Logo.png" und "fonts/..."
      // Diese liegen in Repo unter assets/... => base auf ./assets/ setzen.
      // Dadurch wird Logo.png => assets/Logo.png und fonts/... => assets/fonts/...
      if (/<base\s/i.test(html)) return html;
      return html.replace(/<\/head>/i, `  <base href="./${ASSETS_DIR}/">\n</head>`);
    }

    function normalizeLandingUrl(raw) {
  let url = String(raw || '').trim();

  // Leere Eingabe
  if (!url) return '';

  // Falls jemand nur "tchibo.de" oder "www.tchibo.de" eingibt
  // oder ohne Protokoll allgemein.
  const lower = url.toLowerCase();

  // Wenn Protokoll fehlt (http/https)
  const hasProtocol = /^https?:\/\//i.test(url);

  if (!hasProtocol) {
    // Spezifisch tchibo
    if (lower === 'tchibo.de' || lower.startsWith('tchibo.de/')) {
      url = 'https://www.tchibo.de' + url.slice('tchibo.de'.length);
    } else if (lower === 'www.tchibo.de' || lower.startsWith('www.tchibo.de/')) {
      url = 'https://www.tchibo.de' + url.slice('www.tchibo.de'.length);
    } else {
      // Generischer Fallback: https:// davor
      url = 'https://' + url;
    }
  } else {
    // Wenn Protokoll da ist, aber Domain ist www.tchibo.de oder tchibo.de -> erzwingen https://www.tchibo.de
    // (auch wenn http://)
    url = url.replace(/^https?:\/\/tchibo\.de/i, 'https://www.tchibo.de');
    url = url.replace(/^https?:\/\/www\.tchibo\.de/i, 'https://www.tchibo.de');
  }

  return url;
}

function appendUtmParams(url) {
  // utm_source/dbm & utm_medium/cpm hinzufügen, ohne bestehende Query kaputt zu machen
  const u = new URL(url);
  if (!u.searchParams.has('utm_source')) u.searchParams.set('utm_source', 'dbm');
  if (!u.searchParams.has('utm_medium')) u.searchParams.set('utm_medium', 'cpm');
  return u.toString();
}

function buildTchiboClickTag(landingUrlWithUtm) {
  const base = 'https://tagm.tchibo.de/cl.aspx';
  const params =
    'extProvId=300' +
    '&extProvApi=129768' +
    '&extPu=tchibo-dv360' +
    '&extLi=${INSERTION_ORDER_ID}' +
    '&extPm=${CAMPAIGN_ID}' +
    '&extCr=${CREATIVE_ID}' +
    '&adslotid=${PUBLISHER_ID}' +
    '&gdpr=${GDPR}' +
    '&gdpr_consent=${GDPR_CONSENT_312}' +
    '&url=' + encodeURIComponent(landingUrlWithUtm);

  return `${base}?${params}`;
}

function getFinalClickTag() {
  const normalized = normalizeLandingUrl(appData.landingUrl);
  if (!normalized) return '';
  try {
    const withUtm = appendUtmParams(normalized);
    return buildTchiboClickTag(withUtm);
  } catch {
    return '';
  }
}


    
    function replaceTemplateVars(html, { mode }) {
      // mode: 'preview' oder 'export'

      // Texte
      html = html.replace(/var\s+HEADLINE\s*=\s*".*?";/s, `var HEADLINE = "${escapeJs(appData.headline)}";`);
      html = html.replace(/var\s+SUBLINE\s*=\s*".*?";/s,  `var SUBLINE  = "${escapeJs(appData.subline)}";`);
      html = html.replace(/var\s+CTA_TEXT\s*=\s*".*?";/s, `var CTA_TEXT = "${escapeJs(appData.ctaText)}";`);

      const finalClickTag = getFinalClickTag();
      html = html.replace(/var\s+clickTag\s*=\s*".*?";/s, `var clickTag = "${escapeJs(finalClickTag)}";`);


      // Images:
      // - Preview: Data-URLs, damit der Slider im iframe sofort funktioniert (keine echten 1.jpg im Repo)
      // - Export: "1.jpg", "2.jpg" ... (werden in ZIP geschrieben)
      if (uploadedImages.length > 0) {
        const list = (mode === 'preview')
          ? uploadedImages.map(img => `"${img.data}"`).join(',\n      ')
          : uploadedImages.map(img => `"${img.name}"`).join(',\n      ');

        html = html.replace(/var\s+IMAGE_LIST\s*=\s*\[[\s\S]*?\];/s, `var IMAGE_LIST = [\n      ${list}\n    ];`);
      }

      return html;
    }

    async function fetchText(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return await res.text();
    }

    async function addBinaryToZip(zip, zipPath, url) {
      const res = await fetch(url);
      if (!res.ok) {
        console.warn(`Asset nicht ladbar: ${url} (HTTP ${res.status})`);
        return;
      }
      const buf = await res.arrayBuffer();
      zip.file(zipPath, buf);
    }

    // -----------------------
    // Step 1: Format selection
    // -----------------------
    const formatCheckboxes = document.querySelectorAll('input[type="checkbox"]');
    const nextButton1 = document.getElementById('nextStep1');

    formatCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        selectedFormats = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        nextButton1.disabled = selectedFormats.length === 0;
      });
    });

    nextButton1.addEventListener('click', function() {
      showStep(2);
    });

    // -----------------------
    // Step 2: Image upload
    // -----------------------
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('imageUpload');
    const uploadedContainer = document.getElementById('uploadedImages');

    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    function handleFiles(files) {
      Array.from(files).forEach(file => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            uploadedImages.push({
              name: `${uploadedImages.length + 1}.jpg`,
              data: e.target.result,
              original: file.name
            });
            updateImageDisplay();
          };
          reader.readAsDataURL(file);
        }
      });
    }

    function updateImageDisplay() {
      uploadedContainer.innerHTML = '';
      uploadedImages.forEach((img, index) => {
        const div = document.createElement('div');
        div.className = 'uploaded-image';
        div.innerHTML = `
          <img src="${img.data}" alt="Bild ${index + 1}">
          <div class="number">${index + 1}.jpg</div>
          <button class="remove" type="button" onclick="removeImage(${index})">×</button>
        `;
        uploadedContainer.appendChild(div);
      });
    }

    function removeImage(index) {
      uploadedImages.splice(index, 1);
      uploadedImages.forEach((img, newIndex) => img.name = `${newIndex + 1}.jpg`);
      updateImageDisplay();
    }

    // -----------------------
    // Step 3: Live preview (Template im iframe)
    // -----------------------
    async function generatePreviews() {
      const container = document.getElementById('previewContainer');
      container.innerHTML = '';

      for (const format of selectedFormats) {
        const { w, h } = parseFormat(format);
        const scale = computeScale(w, h);

        // Template laden
        let html;
        try {
          html = await fetchText(`${TEMPLATE_DIR}/${format}.html`);
        } catch (e) {
          const err = document.createElement('div');
          err.className = 'banner-preview';
          err.innerHTML = `<b>Template ${format}.html nicht gefunden oder nicht ladbar.</b><br>${String(e)}`;
          container.appendChild(err);
          continue;
        }

        // Preview: base href auf ./assets/ setzen (damit Logo.png + fonts/... funktionieren)
        html = injectPreviewBase(html);

        html = replaceTemplateVars(html, { mode: 'preview' });

        // Wrapper
        const wrap = document.createElement('div');
        wrap.className = 'banner-preview';
        wrap.innerHTML = `<h4>Banner ${format}</h4>`;

        // Viewport (skaliert)
        const viewport = document.createElement('div');
        viewport.className = 'iframe-viewport';
        viewport.style.width = `${Math.round(w * scale)}px`;
        viewport.style.height = `${Math.round(h * scale)}px`;

        // iFrame
        const iframe = document.createElement('iframe');
        iframe.width = w;
        iframe.height = h;

        // Scripts müssen laufen (Animationen/Slider); Popups für clickTag
        iframe.setAttribute('sandbox', 'allow-scripts allow-popups allow-popups-to-escape-sandbox');

        // Skalierung
        iframe.style.transform = `scale(${scale})`;

        // srcdoc setzen
        iframe.srcdoc = html;

        viewport.appendChild(iframe);
        wrap.appendChild(viewport);

        // Meta-Info
        const meta = document.createElement('div');
        meta.style.marginTop = '12px';
        meta.style.fontSize = '0.9em';
        meta.style.color = '#666';
        meta.innerHTML = `
          <div><strong>Final clickTag:</strong> ${getFinalClickTag() || '-'}</div>
          <div><strong>Landing-URL:</strong> ${normalizeLandingUrl(appData.landingUrl) || '-'}</div>

          <div><strong>Bilder:</strong> ${uploadedImages.length} (${uploadedImages.map(i => i.name).join(', ') || '-'})</div>
          <div><strong>Preview-Assets:</strong> Logo + Fonts werden aus <code>./assets/</code> geladen</div>
        `;
        wrap.appendChild(meta);

        container.appendChild(wrap);
      }
    }

    // -----------------------
    // Export: ZIP mit index.html + Bilder + Logo + fonts/
    // -----------------------
    async function exportBanners() {
      for (const format of selectedFormats) {
        const zip = new JSZip();

        // Template holen
        let templateContent;
        try {
          templateContent = await fetchText(`${TEMPLATE_DIR}/${format}.html`);
        } catch (error) {
          console.error(`Template load failed (${format}):`, error);
          alert(`Template ${format}.html nicht gefunden oder nicht ladbar!`);
          continue;
        }

        // Export: KEIN base href injizieren.
        // Export erwartet Root: Logo.png und fonts/...
        templateContent = replaceTemplateVars(templateContent, { mode: 'export' });

        // index.html
        zip.file('index.html', templateContent);

        // Uploaded images -> Root (1.jpg,2.jpg,...)
        uploadedImages.forEach(img => {
          const base64Data = img.data.split(',')[1];
          zip.file(img.name, base64Data, { base64: true });
        });

        // Logo.png aus assets/ ins Root
        await addBinaryToZip(zip, 'Logo.png', LOGO_ASSET);

        // Fonts aus assets/fonts -> fonts/ im ZIP
        for (const url of FONT_FILES) {
          const filename = url.split('/').pop();
          await addBinaryToZip(zip, `fonts/${filename}`, url);
        }

        // ZIP generieren + Download
        const content = await zip.generateAsync({ type: 'blob' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = `banner-${format}.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);

        // kurzer Abstand zwischen Downloads
        await new Promise(resolve => setTimeout(resolve, 300));
      }
    }

    // -----------------------
    // UI bindings
    // -----------------------
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('headline').addEventListener('input', function() { appData.headline = this.value; });
      document.getElementById('subline').addEventListener('input', function() { appData.subline = this.value; });
      document.getElementById('ctaText').addEventListener('input', function() { appData.ctaText = this.value; });
      document.getElementById('clickUrl').addEventListener('input', function() { appData.landingUrl = this.value; });

      document.getElementById('backStep1').addEventListener('click', () => showStep(1));
      document.getElementById('backStep2').addEventListener('click', () => showStep(2));

      document.getElementById('createPreview').addEventListener('click', async function() {
      const finalClick = getFinalClickTag();
      if (!finalClick) {
        alert('Bitte gib eine gültige Ziel-URL ein!');
        return;
      }
      showStep(3);
      await generatePreviews();
      });


      document.getElementById('exportBanners').addEventListener('click', async function() {
        await exportBanners();
        showStep(4);
      });

      document.getElementById('startOver').addEventListener('click', function() {
        selectedFormats = [];
        uploadedImages = [];
        appData = {
        headline: 'Bereit für deine Ziele?',
        subline: 'Sport Outfits entdecken!',
        ctaText: 'Jetzt shoppen',
        landingUrl: ''
        };


        formatCheckboxes.forEach(cb => cb.checked = false);
        document.getElementById('uploadedImages').innerHTML = '';
        document.getElementById('previewContainer').innerHTML = '';

        document.getElementById('clickUrl').value = '';
        document.getElementById('headline').value = appData.headline;
        document.getElementById('subline').value = appData.subline;
        document.getElementById('ctaText').value = appData.ctaText;

        nextButton1.disabled = true;
        showStep(1);
      });
    });
  </script>
</body>
</html>
