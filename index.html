<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HTML5 Banner Generator</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <style>
    :root{
      --primary:#667eea;
      --success:#4facfe;
      --danger:#ff6b6b;
      --dark:#2c3e50;
      --white:#ffffff;
      --shadow:0 10px 30px rgba(0,0,0,0.1);
      --border-radius:12px;
    }
    *{ margin:0; padding:0; box-sizing:border-box; }

    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;
      color:var(--dark);
      line-height:1.6;
    }
    .container{ max-width: 1400px; margin:0 auto; padding:20px; }

    .header{
      text-align:center;
      margin-bottom:40px;
      color:var(--white);
    }
    .header h1{
      font-size:2.5rem;
      font-weight:700;
      margin-bottom:10px;
      text-shadow:0 2px 10px rgba(0,0,0,0.2);
    }

    .card{
      background:var(--white);
      border-radius:var(--border-radius);
      padding:30px;
      box-shadow:var(--shadow);
      transition:all .3s ease;
    }
    .card:hover{ transform:translateY(-2px); }

    .step-content{ display:none; }
    .step-content.active{ display:block; animation:fadeIn .5s; }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }

    /* ---------- Step 1 ---------- */
    .format-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
      gap:20px;
      margin:20px 0 30px;
    }
    .format-card{
      position:relative;
      cursor:pointer;
      border-radius:var(--border-radius);
      border:3px solid #e0e0e0;
      background:#f8f9fa;
      overflow:hidden;
      transition:all .3s ease;
    }
    .format-card:hover{ transform:translateY(-3px); box-shadow:var(--shadow); }
    .format-card input[type="checkbox"]{ display:none; }

    .format-preview{ padding:20px; text-align:center; transition:all .3s ease; }

    .preview-box{
      background:#fff;
      border-radius:10px;
      padding:22px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      border:2px dashed #ddd;
      min-height:90px;
    }

    /* Checked State: modern, hoher Kontrast */
    .format-card input[type="checkbox"]:checked + .format-preview{
      background:linear-gradient(135deg,#5B6CFF,#35C6FF);
      color:#fff;
    }
    .format-card:has(input[type="checkbox"]:checked){
      border-color:rgba(53,198,255,.95);
      box-shadow:0 14px 35px rgba(0,0,0,0.18);
    }
    .format-card input[type="checkbox"]:checked + .format-preview .preview-box{
      background:rgba(10,15,30,.45);
      border:1px solid rgba(255,255,255,.35);
      box-shadow:0 10px 25px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.18);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      color:#fff;
    }
    .format-card input[type="checkbox"]:checked + .format-preview .preview-box span{
      color:#fff;
      font-weight:800;
      text-shadow:0 2px 10px rgba(0,0,0,.25);
    }
    .format-card input[type="checkbox"]:checked + .format-preview .preview-box small{
      color:rgba(255,255,255,.92);
    }

    .checkmark{
      position:absolute;
      top:10px;
      right:10px;
      background:var(--success);
      color:#fff;
      width:32px;
      height:32px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      transform:scale(0.85);
      transition:all .25s ease;
      box-shadow:0 10px 20px rgba(0,0,0,.18);
    }
    .format-card input[type="checkbox"]:checked ~ .checkmark{
      opacity:1;
      transform:scale(1);
    }

    /* ---------- Inputs ---------- */
    .input-group{ margin-bottom:18px; }
    .input-group label{
      display:block;
      margin-bottom:8px;
      font-weight:600;
      color:var(--dark);
    }
    .input-group input{
      width:100%;
      padding:12px 15px;
      border:2px solid #e0e0e0;
      border-radius:10px;
      font-size:1rem;
      transition:all .3s ease;
    }
    .input-group input:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(102,126,234,0.12);
    }

    .upload-area{
      border:3px dashed #ddd;
      border-radius:var(--border-radius);
      padding:38px;
      text-align:center;
      cursor:pointer;
      transition:all .3s ease;
      position:relative;
      background:#f8f9fa;
    }
    .upload-area:hover, .upload-area.dragover{
      border-color:var(--primary);
      background:rgba(102,126,234,0.05);
    }
    .upload-area input[type="file"]{
      position:absolute; inset:0; opacity:0; cursor:pointer;
    }
    .upload-area i{
      font-size:3rem;
      color:var(--primary);
      margin-bottom:15px;
    }

    .uploaded-images{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(100px,1fr));
      gap:10px;
      margin-top:16px;
    }
    .uploaded-image{
      position:relative;
      aspect-ratio:1;
      border-radius:10px;
      overflow:hidden;
      background:#f0f0f0;
    }
    .uploaded-image img{ width:100%; height:100%; object-fit:cover; }
    .uploaded-image .remove{
      position:absolute;
      top:6px; right:6px;
      background:var(--danger);
      color:#fff;
      border:none;
      border-radius:50%;
      width:26px; height:26px;
      cursor:pointer;
      font-size:.9rem;
    }
    .uploaded-image .number{
      position:absolute;
      bottom:6px; left:6px;
      background:var(--primary);
      color:#fff;
      padding:2px 6px;
      border-radius:6px;
      font-size:.8rem;
      font-weight:700;
    }

    .btn{
      padding:12px 30px;
      border:none;
      border-radius:999px;
      font-size:1rem;
      font-weight:700;
      cursor:pointer;
      transition:all .3s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .btn-primary{
      background:linear-gradient(135deg,var(--primary),#5a6fd8);
      color:#fff;
    }
    .btn-primary:hover:not(:disabled){
      transform:translateY(-2px);
      box-shadow:0 10px 25px rgba(102,126,234,0.3);
    }
    .btn-secondary{ background:#6c757d; color:#fff; }
    .btn-secondary:hover{ background:#545b62; transform:translateY(-2px); }
    .btn-success{
      background:linear-gradient(135deg,var(--success),#00b4db);
      color:#fff;
    }
    .btn-success:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 25px rgba(79,172,254,0.3);
    }

    .button-group{
      display:flex;
      gap:15px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:10px;
    }

    /* ---------- Step 2 Layout: 3 Karten zentriert + Preview erscheint rechts ---------- */
    .stage{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      gap:22px;
      margin: 0 auto;
      max-width: 1320px;
    }

    .input-panel{
      display:grid;
      grid-template-columns:repeat(3, minmax(280px, 1fr));
      gap:20px;
      align-items:stretch;
      transition:transform .35s ease;
      width: 100%;
      max-width: 980px;
    }
    .input-panel .card{
      height:100%;
      display:flex;
      flex-direction:column;
    }

    .preview-panel{
      width: 0;
      max-width: 0;
      opacity: 0;
      pointer-events:none;
      overflow:hidden;
      transition: max-width .35s ease, opacity .25s ease;
    }

    /* wenn Preview aktiv */
    .stage.has-preview .input-panel{
      transform: translateX(-18px);
    }
    .stage.has-preview .preview-panel{
      width: 100%;
      max-width: 520px;
      opacity: 1;
      pointer-events:auto;
    }

    /* ---------- Preview Card ---------- */
    .preview-card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .preview-card-header h3{
      display:flex;
      align-items:center;
      gap:10px;
      margin:0;
      font-size:1.15rem;
    }
    .btn-ghost{
      background:#eef2ff;
      color:#2c3e50;
      border:1px solid #dbe3ff;
      padding:8px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
    }
    .btn-ghost:hover{ filter:brightness(.97); }

    .preview-grid{
      display:flex;
      flex-direction:column;
      gap:14px;
      width:100%;
    }

    /* Layout wenn alle 3 Formate da sind */
    .preview-grid.layout-3{
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto;
      gap:14px;
      align-items:start;
    }
    .preview-item[data-format="300x600"]{ }
    .preview-grid.layout-3 .preview-item[data-format="300x600"]{
      grid-column:1;
      grid-row:1 / span 2;
    }
    .preview-grid.layout-3 .preview-item[data-format="300x250"]{
      grid-column:2;
      grid-row:1;
    }
    .preview-grid.layout-3 .preview-item[data-format="970x250"]{
      grid-column:2;
      grid-row:2;
    }

    /* wenn nur 1 Format -> zentriert */
    .preview-grid.layout-1{
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    /* wenn 2 Formate */
    .preview-grid.layout-2{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:14px;
    }
    /* Spezial: 300x250 + 970x250 untereinander */
    .preview-grid.layout-2.stack{
      flex-direction:column;
      align-items:center;
    }

    .preview-item{
      background:#f8fafc;
      border:1px solid #e6eaf2;
      border-radius:14px;
      padding:12px;
      overflow:hidden; /* WICHTIG: nichts darf raus */
    }
    .preview-item h4{
      margin:0 0 10px 0;
      font-size:0.95rem;
      color:#111827;
      text-align:center;
      font-weight:800;
    }

    /* Viewport hält iframe sicher im Kasten */
    .iframe-viewport{
      position:relative;
      width:100%;
      overflow:hidden;       /* nichts raus */
      background:#fff;
      border-radius:10px;    /* Kasten darf rund sein, Banner bleibt innen clean */
      border:1px solid #e5e7eb;
    }
    .iframe-viewport iframe{
      display:block;
      border:0;
      background:transparent;
    }

    details{
      margin-top:12px;
      background:#f8fafc;
      border:1px solid #e6eaf2;
      border-radius:12px;
      overflow:hidden;
    }
    summary{
      cursor:pointer;
      padding:12px 14px;
      font-weight:800;
      display:flex;
      align-items:center;
      justify-content:space-between;
      list-style:none;
    }
    summary::-webkit-details-marker{ display:none; }
    .details-body{
      padding: 0 14px 14px;
      font-size:.92rem;
      color:#374151;
      word-break:break-word;
    }
    .details-body code{
      display:block;
      background:#111827;
      color:#fff;
      padding:10px;
      border-radius:10px;
      margin-top:8px;
      font-size:.85rem;
      overflow:auto;
    }

    @media (max-width: 1200px){
      .stage{
        flex-wrap:wrap;
      }
      .input-panel{
        max-width: 100%;
      }
      .preview-panel{
        max-width: 100% !important;
        width: 100% !important;
      }
      .stage.has-preview .input-panel{
        transform:none;
      }
    }
    @media (max-width: 980px){
      .input-panel{
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="header">
      <h1><i class="fas fa-magic"></i> HTML5 Banner Generator</h1>
      <p>Erstelle professionelle Display-Banner für Google Ads &amp; DV360</p>
    </header>

    <!-- Step 1 -->
    <div class="step-content active" id="step1">
      <div class="card">
        <h2><i class="fas fa-th-large"></i> Banner-Formate auswählen</h2>

        <div class="format-grid">
          <label class="format-card" for="format-300x250">
            <input type="checkbox" id="format-300x250" value="300x250">
            <div class="format-preview">
              <div class="preview-box">
                <span style="font-weight:800; font-size:1.2em;">300×250</span>
                <small>Medium Rectangle</small>
              </div>
            </div>
            <span class="checkmark"><i class="fas fa-check"></i></span>
          </label>

          <label class="format-card" for="format-300x600">
            <input type="checkbox" id="format-300x600" value="300x600">
            <div class="format-preview">
              <div class="preview-box">
                <span style="font-weight:800; font-size:1.2em;">300×600</span>
                <small>Half Page</small>
              </div>
            </div>
            <span class="checkmark"><i class="fas fa-check"></i></span>
          </label>

          <label class="format-card" for="format-970x250">
            <input type="checkbox" id="format-970x250" value="970x250">
            <div class="format-preview">
              <div class="preview-box">
                <span style="font-weight:800; font-size:1.2em;">970×250</span>
                <small>Billboard</small>
              </div>
            </div>
            <span class="checkmark"><i class="fas fa-check"></i></span>
          </label>
        </div>

        <div class="button-group">
          <button class="btn btn-primary" id="nextStep1" disabled>
            Weiter <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="step-content" id="step2">
      <div class="stage" id="stage">
        <!-- Left: Inputs -->
        <div class="input-panel" id="inputPanel">

          <div class="card">
            <h3><i class="fas fa-images"></i> Bilder hochladen</h3>
            <div class="upload-area" id="uploadArea">
              <i class="fas fa-cloud-upload-alt"></i>
              <p>Bilder hier hinziehen oder klicken</p>
              <p style="font-size:0.9em; color:#666; margin-top:10px;">
                Werden automatisch zu 1.jpg, 2.jpg, etc. umbenannt
              </p>
              <input type="file" id="imageUpload" multiple accept="image/*">
            </div>
            <div class="uploaded-images" id="uploadedImages"></div>
          </div>

          <div class="card">
            <h3><i class="fas fa-font"></i> Texte anpassen</h3>
            <div class="input-group">
              <label for="headline">Headline</label>
              <input type="text" id="headline" value="Bereit für deine Ziele?" maxlength="50">
            </div>
            <div class="input-group">
              <label for="subline">Subline</label>
              <input type="text" id="subline" value="Sport Outfits entdecken!" maxlength="50">
            </div>
            <div class="input-group">
              <label for="ctaText">CTA Text</label>
              <input type="text" id="ctaText" value="Jetzt shoppen" maxlength="20">
            </div>
          </div>

          <div class="card">
            <h3><i class="fas fa-link"></i> Click-URL</h3>

            <div class="input-group">
              <label for="zipName">Naming (für ZIP-Datei)</label>
              <input type="text" id="zipName" placeholder="z.B. KW02_BackToGym" required>
            </div>

            <div class="input-group">
              <label for="clickUrl">Ziel-URL</label>
              <input type="url" id="clickUrl" placeholder="https://example.com" required>
            </div>

            <p style="font-size:0.9em; color:#6b7280; margin-top:6px;">
              Hinweis: utm_source=dbm &amp; utm_medium=cpm werden automatisch ergänzt.
            </p>
          </div>

        </div>

        <!-- Right: Preview (hidden until click) -->
        <div class="preview-panel" id="previewPanel">
          <div class="card">
            <div class="preview-card-header">
              <h3><i class="fas fa-eye"></i> Vorschau</h3>
              <button class="btn-ghost" id="togglePreview" type="button">Ausblenden</button>
            </div>

            <div id="previewGrid" class="preview-grid"></div>

            <details>
              <summary>
                Details
                <span style="opacity:.6;"><i class="fas fa-chevron-down"></i></span>
              </summary>
              <div class="details-body">
                <div><strong>Naming:</strong> <span id="detailName">-</span></div>
                <div style="margin-top:8px;"><strong>Final clickTag:</strong></div>
                <code id="detailClickTag">-</code>
              </div>
            </details>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button class="btn btn-secondary" id="backStep1">
          <i class="fas fa-arrow-left"></i> Zurück
        </button>
        <button class="btn btn-primary" id="createPreview">
          Vorschau erstellen <i class="fas fa-eye"></i>
        </button>
        <button class="btn btn-success" id="exportBanners">
          Export starten <i class="fas fa-download"></i>
        </button>
      </div>
    </div>

    <!-- Step 4 -->
    <div class="step-content" id="step4">
      <div class="card" style="text-align:center;">
        <h2><i class="fas fa-download"></i> Export Status</h2>
        <div style="padding:20px;">
          <div style="margin-bottom:20px;">
            <i class="fas fa-check-circle" style="font-size:3rem; color: var(--success);"></i>
          </div>
          <h3>Export erfolgreich!</h3>
          <p>Deine Banner wurden als ZIP-Dateien heruntergeladen.</p>
        </div>
        <div class="button-group">
          <button class="btn btn-primary" id="startOver">
            <i class="fas fa-plus"></i> Neue Banner erstellen
          </button>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    // -----------------------
    // Config (Ordnerstruktur)
    // -----------------------
    const TEMPLATE_DIR = 'templates';
    const ASSETS_DIR   = 'assets';
    const LOGO_ASSET   = `${ASSETS_DIR}/Logo.png`;

    const FONT_FILES = [
      'Interstate WGL Bold.woff',
      'Interstate WGL Bold.woff2',
      'Interstate WGL Light.woff',
      'Interstate WGL Light.woff2',
      'Interstate WGL Regular.woff',
      'Interstate WGL Regular.woff2',
    ].map(f => `${ASSETS_DIR}/fonts/${f}`);

    // -----------------------
    // State
    // -----------------------
    let selectedFormats = [];
    let uploadedImages = [];
    let appData = {
      headline: 'Bereit für deine Ziele?',
      subline: 'Sport Outfits entdecken!',
      ctaText: 'Jetzt shoppen',
      landingUrl: '',
      zipName: ''
    };

    // -----------------------
    // Helpers
    // -----------------------
    function showStep(stepNumber){
      document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
      const t = document.getElementById(`step${stepNumber}`);
      if (t) t.classList.add('active');
    }

    function escapeJs(str){
      return String(str)
        .replaceAll('\\','\\\\')
        .replaceAll('"','\\"')
        .replaceAll('\n','\\n');
    }

    function sanitizeFilePart(name){
      const s = String(name || '').trim();
      const cleaned = s
        .replace(/\s+/g,'_')
        .replace(/[^\w.\-]+/g,'_')
        .replace(/^_+|_+$/g,'');
      return cleaned || 'banner';
    }

    function parseFormat(format){
      const [w,h] = format.split('x').map(n => parseInt(n,10));
      return {w,h};
    }

    function computeScale(w,h,maxW,maxH){
      return Math.min(1, maxW / w, maxH / h);
    }

    function injectPreviewBase(html){
      if (/<base\s/i.test(html)) return html;
      return html.replace(/<\/head>/i, `  <base href="./${ASSETS_DIR}/">\n</head>`);
    }

    // -----------------------
    // URL / ClickTag Builder
    // -----------------------
    function normalizeLandingUrl(raw){
      let url = String(raw || '').trim();
      if (!url) return '';

      const lower = url.toLowerCase();
      const hasProtocol = /^https?:\/\//i.test(url);

      if (!hasProtocol){
        if (lower === 'tchibo.de' || lower.startsWith('tchibo.de/')){
          url = 'https://www.tchibo.de' + url.slice('tchibo.de'.length);
        } else if (lower === 'www.tchibo.de' || lower.startsWith('www.tchibo.de/')){
          url = 'https://www.tchibo.de' + url.slice('www.tchibo.de'.length);
        } else {
          url = 'https://' + url;
        }
      } else {
        url = url.replace(/^https?:\/\/tchibo\.de/i, 'https://www.tchibo.de');
        url = url.replace(/^https?:\/\/www\.tchibo\.de/i, 'https://www.tchibo.de');
      }
      return url;
    }

    function appendUtmParams(url){
      const u = new URL(url);
      if (!u.searchParams.has('utm_source')) u.searchParams.set('utm_source','dbm');
      if (!u.searchParams.has('utm_medium')) u.searchParams.set('utm_medium','cpm');
      return u.toString();
    }

    // Unencoded (wie gewünscht)
    function buildTchiboClickTagUnencoded(landingUrlWithUtm){
      const base = 'https://tagm.tchibo.de/cl.aspx';
      const params =
        'extProvId=300' +
        '&extProvApi=129768' +
        '&extPu=tchibo-dv360' +
        '&extLi=${INSERTION_ORDER_ID}' +
        '&extPm=${CAMPAIGN_ID}' +
        '&extCr=${CREATIVE_ID}' +
        '&adslotid=${PUBLISHER_ID}' +
        '&gdpr=${GDPR}' +
        '&gdpr_consent=${GDPR_CONSENT_312}' +
        '&url=' + landingUrlWithUtm;

      return `${base}?${params}`;
    }

    function getFinalClickTag(){
      const normalized = normalizeLandingUrl(appData.landingUrl);
      if (!normalized) return '';
      try{
        const withUtm = appendUtmParams(normalized);
        return buildTchiboClickTagUnencoded(withUtm);
      } catch {
        return '';
      }
    }

    // -----------------------
    // Template replacement
    // -----------------------
    function replaceTemplateVars(html,{mode}){
      html = html.replace(/var\s+HEADLINE\s*=\s*".*?";/s, `var HEADLINE = "${escapeJs(appData.headline)}";`);
      html = html.replace(/var\s+SUBLINE\s*=\s*".*?";/s,  `var SUBLINE  = "${escapeJs(appData.subline)}";`);
      html = html.replace(/var\s+CTA_TEXT\s*=\s*".*?";/s, `var CTA_TEXT = "${escapeJs(appData.ctaText)}";`);

      const finalClickTag = getFinalClickTag();
      html = html.replace(/var\s+clickTag\s*=\s*".*?";/s, `var clickTag = "${escapeJs(finalClickTag)}";`);

      if (uploadedImages.length > 0){
        const list = (mode === 'preview')
          ? uploadedImages.map(img => `"${img.data}"`).join(',\n      ')
          : uploadedImages.map(img => `"${img.name}"`).join(',\n      ');

        html = html.replace(/var\s+IMAGE_LIST\s*=\s*\[[\s\S]*?\];/s, `var IMAGE_LIST = [\n      ${list}\n    ];`);
      }
      return html;
    }

    async function fetchText(url){
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return await res.text();
    }

    async function addBinaryToZip(zip, zipPath, url){
      const res = await fetch(url);
      if (!res.ok){
        console.warn(`Asset nicht ladbar: ${url} (HTTP ${res.status})`);
        return;
      }
      const buf = await res.arrayBuffer();
      zip.file(zipPath, buf);
    }

    // -----------------------
    // Step 1: Format selection
    // -----------------------
    const formatCheckboxes = document.querySelectorAll('input[type="checkbox"]');
    const nextButton1 = document.getElementById('nextStep1');

    formatCheckboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        selectedFormats = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(x => x.value);
        nextButton1.disabled = selectedFormats.length === 0;
      });
    });

    nextButton1.addEventListener('click', () => showStep(2));

    // -----------------------
    // Step 2: Image upload
    // -----------------------
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('imageUpload');
    const uploadedContainer = document.getElementById('uploadedImages');

    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', e => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    function handleFiles(files){
      Array.from(files).forEach(file => {
        if (!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = e => {
          uploadedImages.push({
            name: `${uploadedImages.length + 1}.jpg`,
            data: e.target.result,
            original: file.name
          });
          updateImageDisplay();
        };
        reader.readAsDataURL(file);
      });
    }

    function updateImageDisplay(){
      uploadedContainer.innerHTML = '';
      uploadedImages.forEach((img, index) => {
        const div = document.createElement('div');
        div.className = 'uploaded-image';
        div.innerHTML = `
          <img src="${img.data}" alt="Bild ${index + 1}">
          <div class="number">${index + 1}.jpg</div>
          <button class="remove" type="button" onclick="removeImage(${index})">×</button>
        `;
        uploadedContainer.appendChild(div);
      });
    }

    function removeImage(index){
      uploadedImages.splice(index, 1);
      uploadedImages.forEach((img, i) => img.name = `${i + 1}.jpg`);
      updateImageDisplay();
    }
    window.removeImage = removeImage;

    // -----------------------
    // Preview (appears inside Step2)
    // -----------------------
    const stage = document.getElementById('stage');
    const previewGrid = document.getElementById('previewGrid');
    const togglePreviewBtn = document.getElementById('togglePreview');
    const detailNameEl = document.getElementById('detailName');
    const detailClickTagEl = document.getElementById('detailClickTag');

    function setPreviewVisible(on){
      stage.classList.toggle('has-preview', !!on);
    }

    togglePreviewBtn.addEventListener('click', () => {
      const isOn = stage.classList.contains('has-preview');
      setPreviewVisible(!isOn);
      togglePreviewBtn.textContent = isOn ? 'Einblenden' : 'Ausblenden';
    });

    function getOrderedFormatsForPreview(formats){
      const set = new Set(formats);
      const all3 = set.has('300x600') && set.has('300x250') && set.has('970x250');
      if (all3) return ['300x600','300x250','970x250'];

      // sonst: Reihenfolge wie gewählt, aber stabil
      return formats.slice();
    }

    function applyPreviewLayoutClass(formats){
      const set = new Set(formats);
      if (formats.length === 1){
        previewGrid.className = 'preview-grid layout-1';
        return;
      }
      if (formats.length === 3 && set.has('300x600') && set.has('300x250') && set.has('970x250')){
        previewGrid.className = 'preview-grid layout-3';
        return;
      }
      // 2 Formate
      if (formats.length === 2 && set.has('300x250') && set.has('970x250')){
        previewGrid.className = 'preview-grid layout-2 stack';
        return;
      }
      previewGrid.className = 'preview-grid layout-2';
    }

    async function generatePreviews(){
      previewGrid.innerHTML = '';

      const nm = sanitizeFilePart(appData.zipName);
      detailNameEl.textContent = nm || '-';
      detailClickTagEl.textContent = getFinalClickTag() || '-';

      const formats = getOrderedFormatsForPreview(selectedFormats);
      applyPreviewLayoutClass(formats);

      for (const format of formats){
        const {w,h} = parseFormat(format);

        // Zielgrößen pro Preview-Zelle (damit nichts überläuft)
        const cellMaxW = 460;
        const cellMaxH = (format === '300x600') ? 640 : 300;

        const scale = computeScale(w, h, cellMaxW, cellMaxH);
        const viewportW = Math.ceil(w * scale);
        const viewportH = Math.ceil(h * scale);

        let html;
        try{
          html = await fetchText(`${TEMPLATE_DIR}/${format}.html`);
        } catch (e){
          const err = document.createElement('div');
          err.className = 'preview-item';
          err.dataset.format = format;
          err.innerHTML = `<h4>${format}</h4><div style="padding:10px;color:#b91c1c;">Template nicht ladbar<br>${String(e)}</div>`;
          previewGrid.appendChild(err);
          continue;
        }

        html = injectPreviewBase(html);
        html = replaceTemplateVars(html, {mode:'preview'});

        const item = document.createElement('div');
        item.className = 'preview-item';
        item.dataset.format = format;

        const title = document.createElement('h4');
        title.textContent = format;
        item.appendChild(title);

        const viewport = document.createElement('div');
        viewport.className = 'iframe-viewport';
        viewport.style.width = `${viewportW}px`;
        viewport.style.height = `${viewportH}px`;

        const iframe = document.createElement('iframe');
        iframe.width = w;
        iframe.height = h;
        iframe.setAttribute('sandbox','allow-scripts allow-popups allow-popups-to-escape-sandbox');
        iframe.style.transform = `scale(${scale})`;
        iframe.style.transformOrigin = '0 0';
        iframe.srcdoc = html;

        viewport.appendChild(iframe);
        item.appendChild(viewport);

        previewGrid.appendChild(item);
      }
    }

    // -----------------------
    // Export ZIP
    // -----------------------
    async function exportBanners(){
      const baseName = sanitizeFilePart(appData.zipName);

      for (const format of selectedFormats){
        const zip = new JSZip();

        let templateContent;
        try{
          templateContent = await fetchText(`${TEMPLATE_DIR}/${format}.html`);
        } catch (e){
          alert(`Template ${format}.html nicht gefunden oder nicht ladbar!`);
          continue;
        }

        templateContent = replaceTemplateVars(templateContent, {mode:'export'});
        zip.file('index.html', templateContent);

        uploadedImages.forEach(img => {
          const base64Data = img.data.split(',')[1];
          zip.file(img.name, base64Data, {base64:true});
        });

        await addBinaryToZip(zip, 'Logo.png', LOGO_ASSET);

        for (const url of FONT_FILES){
          const filename = url.split('/').pop();
          await addBinaryToZip(zip, `fonts/${filename}`, url);
        }

        const content = await zip.generateAsync({type:'blob'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = `${format}_${baseName}.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);

        await new Promise(r => setTimeout(r, 300));
      }
    }

    // -----------------------
    // UI bindings
    // -----------------------
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('headline').addEventListener('input', e => appData.headline = e.target.value);
      document.getElementById('subline').addEventListener('input', e => appData.subline = e.target.value);
      document.getElementById('ctaText').addEventListener('input', e => appData.ctaText = e.target.value);
      document.getElementById('clickUrl').addEventListener('input', e => appData.landingUrl = e.target.value);
      document.getElementById('zipName').addEventListener('input', e => appData.zipName = e.target.value);

      document.getElementById('backStep1').addEventListener('click', () => {
        setPreviewVisible(false);
        togglePreviewBtn.textContent = 'Ausblenden';
        showStep(1);
      });

      document.getElementById('createPreview').addEventListener('click', async () => {
        const finalClick = getFinalClickTag();
        const nm = sanitizeFilePart(appData.zipName);

        if (!finalClick){
          alert('Bitte gib eine gültige Ziel-URL ein!');
          return;
        }
        if (!String(appData.zipName || '').trim()){
          alert('Bitte gib ein Naming für die ZIP-Datei ein!');
          return;
        }

        setPreviewVisible(true);
        togglePreviewBtn.textContent = 'Ausblenden';
        await generatePreviews();
      });

      document.getElementById('exportBanners').addEventListener('click', async () => {
        const finalClick = getFinalClickTag();
        if (!finalClick){
          alert('Bitte gib eine gültige Ziel-URL ein!');
          return;
        }
        if (!String(appData.zipName || '').trim()){
          alert('Bitte gib ein Naming für die ZIP-Datei ein!');
          return;
        }
        await exportBanners();
        showStep(4);
      });

      document.getElementById('startOver').addEventListener('click', () => {
        selectedFormats = [];
        uploadedImages = [];
        appData = {
          headline: 'Bereit für deine Ziele?',
          subline: 'Sport Outfits entdecken!',
          ctaText: 'Jetzt shoppen',
          landingUrl: '',
          zipName: ''
        };

        formatCheckboxes.forEach(cb => cb.checked = false);
        nextButton1.disabled = true;

        document.getElementById('uploadedImages').innerHTML = '';
        document.getElementById('headline').value = appData.headline;
        document.getElementById('subline').value = appData.subline;
        document.getElementById('ctaText').value = appData.ctaText;
        document.getElementById('clickUrl').value = '';
        document.getElementById('zipName').value = '';

        previewGrid.innerHTML = '';
        setPreviewVisible(false);
        togglePreviewBtn.textContent = 'Ausblenden';

        showStep(1);
      });

      console.log('HTML5 Banner Generator geladen!');
    });
  </script>
</body>
</html>
